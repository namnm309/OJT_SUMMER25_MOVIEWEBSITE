@model ConfirmBookingViewModel
@{
    ViewData["Title"] = "Xác Nhận Đặt Vé";
    Layout = "_Layout";
}

<div class="container-fluid bg-dark text-white min-vh-100 py-4">
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="text-danger">Xác Nhận Thông Tin Đặt Vé</h1>
        </div>

        <form asp-action="ConfirmBooking" method="post" class="needs-validation" novalidate>
            <div class="row">
                <!-- Movie & Booking Details -->
                <div class="col-lg-8">
                    <div class="card bg-secondary text-white mb-4">
                        <div class="card-header bg-danger">
                            <h4 class="mb-0"><i class="fas fa-film"></i> Thông Tin Phim</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <img src="@Model.MoviePoster" alt="@Model.MovieTitle" class="img-fluid rounded">
                                </div>
                                <div class="col-md-8">
                                    <h3 class="text-danger">@Model.MovieTitle</h3>
                                    <div class="booking-details">
                                        <p><i class="fas fa-map-marker-alt text-danger"></i> <strong>Phòng chiếu:</strong> @Model.CinemaRoom</p>
                                        <p><i class="fas fa-calendar text-danger"></i> <strong>Ngày chiếu:</strong> @Model.ShowDate.ToString("dddd, dd/MM/yyyy")</p>
                                        <p><i class="fas fa-clock text-danger"></i> <strong>Giờ chiếu:</strong> @Model.ShowTime.ToString(@"hh\:mm")</p>
                                        <p><i class="fas fa-couch text-danger"></i> <strong>Ghế đã chọn:</strong> @string.Join(", ", Model.SelectedSeats)</p>
                                        <p><i class="fas fa-ticket-alt text-danger"></i> <strong>Số lượng vé:</strong> @Model.TotalSeats</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="card bg-secondary text-white">
                        <div class="card-header bg-danger">
                            <h4 class="mb-0"><i class="fas fa-user"></i> Thông Tin Khách Hàng</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Họ và tên</label>
                                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                                               value="@Model.CustomerName" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Số điện thoại</label>
                                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                                               value="@Model.CustomerPhone" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control bg-dark text-white border-secondary" 
                                               value="@Model.CustomerEmail" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">CMND/CCCD</label>
                                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                                               value="@Model.CustomerIdCard" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="col-lg-4">
                    <div class="card bg-secondary text-white position-sticky" style="top: 1rem;">
                        <div class="card-header bg-success">
                            <h4 class="mb-0"><i class="fas fa-money-bill-wave"></i> Thanh Toán</h4>
                        </div>
                        <div class="card-body">
                            <!-- Price Breakdown -->
                            <div class="price-breakdown">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Giá vé (@Model.TotalSeats vé):</span>
                                    <span>@String.Format("{0:N0}", Model.TotalPrice) VNĐ</span>
                                </div>
                                
                                <!-- Points Section -->
                                @if(Model.AvailablePoints > 0)
                                {
                                    <hr class="border-secondary">
                                    <div class="points-section">
                                        <h6 class="text-warning"><i class="fas fa-coins"></i> Điểm thưởng có sẵn: @Model.AvailablePoints điểm</h6>
                                        <div class="form-check">
                                            <input asp-for="UsePoints" class="form-check-input" type="checkbox" id="usePointsCheck">
                                            <label class="form-check-label" for="usePointsCheck">
                                                Sử dụng điểm thưởng
                                            </label>
                                        </div>
                                        <div id="pointsDetails" style="display: none;" class="mt-2">
                                            <div class="mb-2">
                                                <label class="form-label">Số điểm sử dụng:</label>
                                                <input asp-for="PointsToUse" type="number" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                                       min="0" max="@Model.AvailablePoints" placeholder="Nhập số điểm">
                                            </div>
                                            <small class="text-muted">1 điểm = 1,000 VNĐ</small>
                                        </div>
                                    </div>
                                    
                                    <div id="discountRow" style="display: none;" class="d-flex justify-content-between mb-2 text-warning">
                                        <span>Giảm giá (điểm):</span>
                                        <span id="discountAmount">0 VNĐ</span>
                                    </div>
                                }

                                <hr class="border-secondary">
                                <div class="d-flex justify-content-between fs-5 fw-bold text-success">
                                    <span>Tổng cần thanh toán:</span>
                                    <span id="finalAmount">@String.Format("{0:N0}", Model.FinalPrice) VNĐ</span>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="mt-3">
                                <label asp-for="Notes" class="form-label">Ghi chú (tùy chọn)</label>
                                <textarea asp-for="Notes" class="form-control bg-dark text-white border-secondary" 
                                          rows="3" placeholder="Nhập ghi chú nếu có..."></textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="button" class="btn btn-outline-light" onclick="history.back()">
                                    <i class="fas fa-arrow-left"></i> Quay lại
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-check"></i> Xác Nhận Đặt Vé
                                </button>
                            </div>

                            <!-- Terms -->
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Bằng việc xác nhận, bạn đồng ý với 
                                    <a href="#" class="text-warning">điều khoản sử dụng</a> của chúng tôi.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Fields -->
            <input asp-for="ShowTimeId" type="hidden">
            <input asp-for="MovieTitle" type="hidden">
            <input asp-for="MoviePoster" type="hidden">
            <input asp-for="CinemaRoom" type="hidden">
            <input asp-for="ShowDate" type="hidden">
            <input asp-for="ShowTime" type="hidden">
            <input asp-for="TotalPrice" type="hidden">
            <input asp-for="TotalSeats" type="hidden">
            <input asp-for="PricePerTicket" type="hidden">
            
            @for (int i = 0; i < Model.SelectedSeats.Count; i++)
            {
                <input asp-for="SelectedSeats[i]" type="hidden">
            }
            @for (int i = 0; i < Model.SelectedSeatIds.Count; i++)
            {
                <input asp-for="SelectedSeatIds[i]" type="hidden">
            }
        </form>
    </div>
</div>

<style>
    .booking-details p {
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }
    
    .price-breakdown {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        padding: 1rem;
    }
    
    .points-section {
        background: rgba(255, 193, 7, 0.1);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .card {
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .form-control:focus {
        background-color: #2c2c2c !important;
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        color: white !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const usePointsCheck = document.getElementById('usePointsCheck');
    const pointsDetails = document.getElementById('pointsDetails');
    const pointsToUseInput = document.querySelector('input[name="PointsToUse"]');
    const discountRow = document.getElementById('discountRow');
    const discountAmount = document.getElementById('discountAmount');
    const finalAmount = document.getElementById('finalAmount');
    
    const totalPrice = @Model.TotalPrice;
    const maxPoints = @Model.AvailablePoints;

    if (usePointsCheck) {
        usePointsCheck.addEventListener('change', function() {
            if (this.checked) {
                pointsDetails.style.display = 'block';
            } else {
                pointsDetails.style.display = 'none';
                pointsToUseInput.value = '';
                updateFinalPrice();
            }
        });

        pointsToUseInput.addEventListener('input', function() {
            let points = parseInt(this.value) || 0;
            
            // Validate points
            if (points > maxPoints) {
                points = maxPoints;
                this.value = maxPoints;
            }
            if (points < 0) {
                points = 0;
                this.value = 0;
            }

            updateFinalPrice();
        });
    }

    function updateFinalPrice() {
        const points = parseInt(pointsToUseInput?.value) || 0;
        const discount = Math.min(points * 1000, totalPrice); // 1 point = 1000 VND
        const finalPrice = totalPrice - discount;

        if (points > 0 && discountRow) {
            discountRow.style.display = 'flex';
            discountAmount.textContent = new Intl.NumberFormat('vi-VN').format(discount) + ' VNĐ';
        } else if (discountRow) {
            discountRow.style.display = 'none';
        }

        finalAmount.textContent = new Intl.NumberFormat('vi-VN').format(finalPrice) + ' VNĐ';
    }

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script> 