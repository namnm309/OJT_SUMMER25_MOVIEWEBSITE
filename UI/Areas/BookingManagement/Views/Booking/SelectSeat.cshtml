@model SelectSeatViewModel
@{
    ViewData["Title"] = "Ch·ªçn Gh·∫ø";
    Layout = "_Layout";
}
<link rel="stylesheet" href="~/css/BookingManagement/select-seat.css" />

<div class="main-container">
    <!-- Ph·∫ßn th√¥ng tin phim v√† ch·ªçn gh·∫ø -->
    <div class="movie-section">
        <!-- Th√¥ng tin phim -->
        <div class="movie-info-card">
            <div class="movie-poster">
                <div class="movie-poster">
                    <h1 class="movie-title">@Model.MovieTitle</h1>
                </div>
            </div>

            <div class="movie-details">
                <h1 class="movie-title">@Model.MovieTitle</h1>

                <div class="movie-meta" id="movieMeta">
                    <span class="meta-item">üìΩÔ∏è ƒêang t·∫£i...</span>
                    <span class="meta-item">‚è±Ô∏è ƒêang t·∫£i...</span>
                    <span class="meta-item">‚≠ê ƒêang t·∫£i...</span>
                    <span class="meta-item">üé¨ ƒêang t·∫£i...</span>
                </div>

                <div class="movie-description" id="movieDescription">
                    ƒêang t·∫£i th√¥ng tin phim...
                </div>

                <!-- Th√¥ng tin su·∫•t chi·∫øu -->
                <div class="showtime-info">
                    <div class="showtime-details">
                        <div class="showtime-item">
                            <div class="showtime-label">üé≠ R·∫°p chi·∫øu</div>
                            <div class="showtime-value" id="cinemaRoom">@Model.CinemaRoom</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üìÖ Ng√†y chi·∫øu</div>
                            <div class="showtime-value" id="showDate">@Model.ShowTime.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üïê Gi·ªù chi·∫øu</div>
                            <div class="showtime-value" id="showTime">@Model.ShowTime.ToString("HH:mm")</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üé´ Lo·∫°i v√©</div>
                            <div class="showtime-value" id="ticketType">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ph·∫ßn ch·ªçn gh·∫ø -->
        <div class="seat-selection">
            <div class="selection-header">
                <h2 class="section-title">Select Your Seats</h2>
                <div class="seat-info" id="seatInfo">
                    <span class="seat-count">ƒêang t·∫£i...</span>
                    <div class="seat-types" id="seatTypes">
                        <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ API -->
                    </div>
                </div>
            </div>

            <!-- M√†n h√¨nh cong v·ªõi hi·ªáu ·ª©ng ƒë·∫πp h∆°n -->
            <div class="screen-container">
                <div class="screen">
                    <span class="screen-text">SCREEN</span>
                </div>
            </div>

            <div class="seat-map" id="seatMap">
                <!-- Gh·∫ø s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
            </div>

            <!-- Legend c·∫£i ti·∫øn -->
            <div class="seat-legend">
                <div class="legend-item">
                    <div class="legend-color seat-available"></div>
                    <span>Gh·∫ø tr·ªëng</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color seat-selected"></div>
                    <span>Gh·∫ø ƒë√£ ch·ªçn</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color seat-unavailable"></div>
                    <span>Gh·∫ø ƒë√£ ƒë·∫∑t</span>
                </div>
                <div class="legend-item">
                <div class="legend-color seat-vip"></div>
                <span>Gh·∫ø VIP</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat pending-mine"></div>
                <span>ƒêang ch·ªù (c·ªßa b·∫°n)</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat pending-others"></div>
                <span>ƒêang ch·ªù (ng∆∞·ªùi kh√°c)</span>
            </div>
            </div>
        </div>
    </div>

    <!-- Ph·∫ßn ƒë·∫∑t v√© - sidebar b√™n ph·∫£i v·ªõi style m·ªõi -->
    <div class="booking-section">
        <div class="movie-tickets-card">
            <div class="card-header">
                <h3><i class="fas fa-ticket-alt"></i> MOVIE TICKETS</h3>
                <div class="ticket-icon">üé´</div>
            </div>

            <div class="ticket-details">
                <div class="detail-row">
                    <span class="label">Date & Time</span>
                    <span class="value" id="ticketDateTime">@Model.ShowTime.ToString("dd/MM/yyyy, HH:mm")</span>
                </div>
                <div class="detail-row">
                    <span class="label">Tickets (Double comfort)</span>
                    <span class="value" id="ticketCount">@Model.SelectedSeatCount</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total</span>
                    <span class="value total-amount" id="ticketTotal">@String.Format("{0:N0}", Model.TotalPrice)‚Ç´</span>
                </div>
            </div>

            <div class="selected-seats-display">
                <div class="seats-grid" id="selectedSeatsDisplay">
                    <!-- Gh·∫ø ƒë∆∞·ª£c ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>

            <div class="ticket-summary">
                <div class="summary-item">
                    <span>1 Ticket Double comfort</span>
                    <span>2D</span>
                </div>
                <div class="total-price-section">
                    <span class="total-label">TOTAL PRICE</span>
                    <div class="total-row">
                        <span>T·ªïng c·ªông:</span>
                        <span class="total-amount" id="totalPrice">@String.Format("{0:N0}", Model.TotalPrice)‚Ç´</span>
                    </div>
                </div>
            </div>

            <!-- X√≥a ph·∫ßn n√†y:
            <button type="button" class="btn-add-parking">
                ADD PARKING
            </button>
            -->

            <div class="ticket-actions">
                <button id="continueBtn" class="btn-continue" disabled>
                    CH·ªåN GH·∫æ ƒê·ªÇ THANH TO√ÅN
                </button>
                <button id="payVnpayBtn" class="btn-continue" style="display:none; margin-top: 10px;">
                    THANH TO√ÅN QUA VNPAY
                </button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/BookingManagement/SelectSeat/Seats.js"></script>
<script src="~/js/BookingManagement/SelectSeat/MovieInfo.js"></script>
<script src="~/js/BookingManagement/SelectSeat/Payment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Kh·ªüi t·∫°o module seat
        window.SeatModule.init({
            seatMapContainer: document.getElementById('seatMap'),
            selectedSeatsDisplay: document.getElementById('selectedSeatsDisplay'),
            totalPriceElement: document.getElementById('totalPrice'),
            continueBtn: document.getElementById('continueBtn'),
            showTimeId: '@Model.ShowTimeId'
        });
        // Kh·ªüi t·∫°o module movie info
        window.MovieInfoModule.init({
            showTimeId: '@Model.ShowTimeId'
        });
        // Kh·ªüi t·∫°o module payment
        window.PaymentModule.init({
            continueBtn: document.getElementById('continueBtn'),
            showTimeId: '@Model.ShowTimeId'
        });
        // G·ªçi c√°c h√†m kh·ªüi t·∫°o d·ªØ li·ªáu
        window.SeatModule.loadSeats();
        window.SeatModule.updateDisplay();
        window.MovieInfoModule.loadMovieAndShowtimeDetails();
        // G√°n s·ª± ki·ªán cho n√∫t thanh to√°n
        document.getElementById('continueBtn').addEventListener('click', function() {
            window.PaymentModule.validateAndContinue();
        });

        // Th√™m h√†m refresh tr·∫°ng th√°i gh·∫ø ƒë·ªãnh k·ª≥
        function startSeatStatusRefresh() {
            setInterval(async () => {
                try {
                    console.log('Refreshing seat status...');
                    await window.SeatModule.loadSeats(); // Reload gh·∫ø ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                } catch (error) {
                    console.error('Error refreshing seat status:', error);
                }
            }, 10000); // Refresh m·ªói 10 gi√¢y
        }

        // Kh·ªüi t·∫°o
        updateDisplay();
        loadSeats(); // Load gh·∫ø t·ª´ API
        loadMovieAndShowtimeDetails(); // Load th√¥ng tin phim
        startSeatStatusRefresh(); // B·∫Øt ƒë·∫ßu refresh tr·∫°ng th√°i gh·∫ø
    });

    function disableContinueBtn() {
        var btn = document.getElementById('continueBtn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'ƒê√É X√ÅC NH·∫¨N';
        }
    }
</script>