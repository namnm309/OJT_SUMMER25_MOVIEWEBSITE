@model SelectSeatViewModel
@{
    ViewData["Title"] = "Ch·ªçn Gh·∫ø";
    Layout = "_Layout";
}
<link rel="stylesheet" href="~/css/BookingManagement/select-seat.css" />
<link rel="stylesheet" href="~/css/Shared/fix-header-offset.css" />
    <link rel="stylesheet" href="~/css/HomePage/layout.css" />
    <link rel="stylesheet" href="~/css/HomePage/movie-poster-overlay.css" />
    <link rel="stylesheet" href="~/css/HomePage/responsive.css" />
    <link rel="stylesheet" href="~/css/MovieDetails/movie-details-mostly.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/MovieDetails/movie-details.css" asp-append-version="true" />
    
<div class="main-container with-header-offset">
    <!-- Ph·∫ßn th√¥ng tin phim v√† ch·ªçn gh·∫ø -->
    <div class="movie-section">
        <!-- Th√¥ng tin phim -->
        <div class="movie-info-cards select-seat-scope">
            <div class="movie-posters">
                <img src="/images/placeholder-movie.jpg" alt="Movie Poster" class="movie-poster" />
            </div>

            <div class="movie-detailss">
                <h1 class="movie-title">@Model.MovieTitle</h1>

                <div class="movie-meta" id="movieMeta">
                    <span class="meta-item">üìΩÔ∏è ƒêang t·∫£i...</span>
                    <span class="meta-item">‚è±Ô∏è ƒêang t·∫£i...</span>
                    <span class="meta-item">‚≠ê ƒêang t·∫£i...</span>
                    <span class="meta-item">üé¨ ƒêang t·∫£i...</span>
                </div>

                <div class="movie-description" id="movieDescription">
                    ƒêang t·∫£i th√¥ng tin phim...
                </div>

                <!-- Th√¥ng tin su·∫•t chi·∫øu -->
                <div class="showtime-info">
                    <div class="showtime-details">
                        <div class="showtime-item">
                            <div class="showtime-label">üé≠ R·∫°p chi·∫øu</div>
                            <div class="showtime-value" id="cinemaRoom">@Model.CinemaRoom</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üìÖ Ng√†y chi·∫øu</div>
                            <div class="showtime-value" id="showDate">@Model.ShowTime.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üïê Gi·ªù chi·∫øu</div>
                            <div class="showtime-value" id="showTime">@Model.ShowTime.ToString("HH:mm")</div>
                        </div>
                        <div class="showtime-item">
                            <div class="showtime-label">üé´ Lo·∫°i v√©</div>
                            <div class="showtime-value" id="ticketType">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ph·∫ßn ch·ªçn gh·∫ø -->
        <div class="seat-selection">
            <div class="selection-header">
                <h2 class="section-title">Select Your Seats</h2>
                <div class="seat-info" id="seatInfo">
                    <span class="seat-count">ƒêang t·∫£i...</span>
                    <div class="seat-types" id="seatTypes">
                        <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ API -->
                    </div>
                </div>
            </div>
            
            <!-- Hi·ªÉn th·ªã gh·∫ø ƒë√£ ch·ªçn -->
            <div class="selected-seats-header" id="selectedSeatsHeader" style="display: none;">
                <!-- Gh·∫ø ƒë√£ ch·ªçn s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>

            <!-- M√†n h√¨nh cong v·ªõi hi·ªáu ·ª©ng ƒë·∫πp h∆°n -->
            <div class="screen-container">
                <div class="screen">
                    <span class="screen-text">SCREEN</span>
                </div>
            </div>

            <div class="seat-map" id="seatMap">
                <!-- Gh·∫ø s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
            </div>

            <!-- Legend c·∫£i ti·∫øn -->
            <div class="seat-legend">
                <div class="legend-item">
                    <div class="legend-seat" style="color: #ffffff;"></div>
                    <span>Gh·∫ø tr·ªëng</span>
                </div>
                <div class="legend-item">
                    <div class="legend-seat selected"></div>
                    <span>Gh·∫ø ƒë√£ ch·ªçn</span>
                </div>
                <div class="legend-item">
                    <div class="legend-seat" style="color: #5a899d;"></div>
                    <span>Gh·∫ø ƒë√£ ƒë·∫∑t</span>
                </div>
                <div class="legend-item">
                <div class="legend-seat" style="color: #ffffff;"></div>
                <span>Gh·∫ø VIP</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat selected"></div>
                <span>ƒêang ch·ªù (c·ªßa b·∫°n)</span>
            </div>
            <div class="legend-item">
                <div class="legend-seat" style="color: #5a899d;"></div>
                <span>ƒêang ch·ªù (ng∆∞·ªùi kh√°c)</span>
            </div>
            </div>
        </div>
    </div>

    <!-- Ph·∫ßn ƒë·∫∑t v√© - sidebar b√™n ph·∫£i v·ªõi style m·ªõi -->
    <div class="booking-section">
        <div class="movie-tickets-card">
            <div class="card-header">
                <h3><i class="fas fa-ticket-alt"></i> MOVIE TICKETS</h3>
                <div class="ticket-icon">üé´</div>
            </div>

            <div class="ticket-details">
                <div class="detail-row">
                    <span class="label">Date & Time</span>
                    <span class="value" id="ticketDateTime">@Model.ShowTime.ToString("dd/MM/yyyy, HH:mm")</span>
                </div>
                <div class="detail-row">
                    <span class="label">Tickets (Double comfort)</span>
                    <span class="value" id="ticketCount">@Model.SelectedSeatCount</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total</span>
                    <span class="value total-amount" id="ticketTotal">@String.Format("{0:N0}", Model.TotalPrice)‚Ç´</span>
                </div>
                <div class="detail-row promotion-row">
                    <span class="label">Khuy·∫øn m√£i</span>
                    <button type="button" id="showPromotionsBtn" class="btn-show-promotions">
                        <i class="fas fa-ticket-alt"></i> Ch·ªçn m√£
                    </button>
                </div>
            </div>

            <div class="selected-seats-display">
                <div class="seats-grid" id="selectedSeatsDisplay">
                    <!-- Gh·∫ø ƒë∆∞·ª£c ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>

            <div class="ticket-summary">
                <div class="summary-item">
                    <span>1 Ticket Double comfort</span>
                    <span>2D</span>
                </div>
                <div class="total-price-section">
                    <span class="total-label">TOTAL PRICE</span>
                    <div class="total-row">
                        <span>T·ªïng c·ªông:</span>
                        <span class="total-amount" id="totalPrice">@String.Format("{0:N0}", Model.TotalPrice)‚Ç´</span>
                    </div>
                </div>
            </div>

            <!-- X√≥a ph·∫ßn n√†y:
            <button type="button" class="btn-add-parking">
                ADD PARKING
            </button>
            -->

            <div class="ticket-actions">
                <button id="continueBtn" class="btn-continue" disabled>
                    CH·ªåN GH·∫æ ƒê·ªÇ THANH TO√ÅN
                </button>
                <button id="payVnpayBtn" class="btn-continue" style="display:none; margin-top: 10px;">
                    THANH TO√ÅN QUA VNPAY
                </button>
                <button id="cancelSeatsBtn" type="button" class="btn-cancel" style="display:none; margin-top: 10px;">
                    H·ª¶Y GH·∫æ
                </button>
                <button id="cancelVoucherBtn" type="button" class="btn-cancel" style="display:none; margin-top: 10px;">
                    B·ªé VOUCHER
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Popup cho promotions -->
<div id="promotionsPopup" class="promotions-popup" style="display: none;">
    <div class="popup-content">
        <div class="popup-header">
            <h4>M√£ khuy·∫øn m√£i c·ªßa b·∫°n</h4>
            <button class="close-popup">&times;</button>
        </div>
        <div class="promotions-list">
            <!-- Promotions s·∫Ω ƒë∆∞·ª£c load v√†o ƒë√¢y -->
        </div>
    </div>
</div>

<!-- Styles cho popup khuy·∫øn m√£i -->
<style>
    /* H√†ng khuy·∫øn m√£i trong b·∫£ng chi ti·∫øt */
    .promotion-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-top: 6px;
    }

    /* N√∫t m·ªü popup */
    .btn-show-promotions {
        background: linear-gradient(45deg,#ff416c,#ff4b2b);
        color: #fff;
        border: none;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all .25s ease;
    }

    .btn-show-promotions:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255,75,43,.35);
    }

    /* Overlay popup */
    .promotions-popup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.55);
        display: none; /* hi·ªÉn th·ªã b·∫±ng JS */
        align-items: center;
        justify-content: center;
        z-index: 1050;
        animation: fadeIn .25s forwards;
    }

    @@keyframes fadeIn {
        from {opacity: 0;} to {opacity: 1;}
    }

    .popup-content {
        background: #fff;
        border-radius: 12px;
        width: 95%;
        max-width: 420px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 30px rgba(0,0,0,.25);
        transform: translateY(-15px);
        animation: slideDown .3s forwards;
    }

    @@keyframes slideDown {
        to {transform: translateY(0);}
    }

    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        border-bottom: 1px solid #eee;
    }

    .popup-header h4 {margin: 0;font-size: 1.05rem;color: #333;font-weight: 600;}

    .close-popup {
        background: none;
        border: none;
        font-size: 24px;
        line-height: 1;
        cursor: pointer;
        color: #999;
        transition: color .2s;
    }

    .close-popup:hover {color:#333;}

    .promotions-list {padding: 14px 18px;}

    .promotion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        margin-bottom: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        background: #fafafa;
        transition: all .25s ease;
        cursor: pointer;
    }

    .promotion-item:hover {box-shadow: 0 4px 12px rgba(0,0,0,.08);border-color:#ff4b2b;}
    .promotion-item.selected {border-color:#ff4b2b;background:#ffeae4;}

    .promotion-discount {font-size: 1rem;font-weight: 700;color:#ff4b2b;}
    .promotion-expiry {font-size: .85rem;color:#666;}

    .btn-select-promotion {
        background:#ff4b2b;
        border:none;
        color:#fff;
        padding:6px 10px;
        border-radius:6px;
        font-size:.8rem;
        cursor:pointer;
        transition:background .2s;
    }

    .btn-select-promotion:hover {background:#ff416c;}
    .btn-cancel {
        background: #343a40;
        color: #fff;
        border: 1px solid #495057;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all .25s ease;
    }
    .btn-cancel:hover {background:#495057;}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="~/js/BookingManagement/SelectSeat/Seats.js"></script>
<script src="~/js/BookingManagement/SelectSeat/MovieInfo.js"></script>
<script src="~/js/BookingManagement/SelectSeat/Payment.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Kh·ªüi t·∫°o module seat
        window.SeatModule.init({
            seatMapContainer: document.getElementById('seatMap'),
            selectedSeatsDisplay: document.getElementById('selectedSeatsDisplay'),
            totalPriceElement: document.getElementById('totalPrice'),
            continueBtn: document.getElementById('continueBtn'),
            showTimeId: '@Model.ShowTimeId'
        });
        // Kh·ªüi t·∫°o module movie info
        window.MovieInfoModule.init({
            showTimeId: '@Model.ShowTimeId'
        });
        // Kh·ªüi t·∫°o module payment
        window.PaymentModule.init({
            continueBtn: document.getElementById('continueBtn'),
            showTimeId: '@Model.ShowTimeId'
        });
        // G·ªçi c√°c h√†m kh·ªüi t·∫°o d·ªØ li·ªáu
        window.SeatModule.loadSeats();
        window.SeatModule.updateDisplay();
        window.MovieInfoModule.loadMovieAndShowtimeDetails();
        // G√°n s·ª± ki·ªán cho n√∫t thanh to√°n
        document.getElementById('continueBtn').addEventListener('click', function() {
            window.PaymentModule.validateAndContinue();
        });

        // Th√™m h√†m refresh tr·∫°ng th√°i gh·∫ø ƒë·ªãnh k·ª≥
        function startSeatStatusRefresh() {
            setInterval(async () => {
                try {
                    console.log('Refreshing seat status...');
                    await window.SeatModule.loadSeats(); // Reload gh·∫ø ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                } catch (error) {
                    console.error('Error refreshing seat status:', error);
                }
            }, 10000); // Refresh m·ªói 10 gi√¢y
        }

        // Kh·ªüi t·∫°o
        updateDisplay();
        loadSeats(); // Load gh·∫ø t·ª´ API
        loadMovieAndShowtimeDetails(); // Load th√¥ng tin phim
        startSeatStatusRefresh(); // B·∫Øt ƒë·∫ßu refresh tr·∫°ng th√°i gh·∫ø
    });

    function disableContinueBtn() {
        var btn = document.getElementById('continueBtn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'ƒê√É X√ÅC NH·∫¨N';
        }
    }
</script>