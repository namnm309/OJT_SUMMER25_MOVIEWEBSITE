@{
    ViewData["Title"] = "Quản lý phim - Cinema City";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Homepage Base CSS for Footer -->
    <link rel="stylesheet" href="~/css/HomePage/base.css" />
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="~/css/dashboard.css" />
    <!-- Shared Footer CSS -->
    <link rel="stylesheet" href="~/css/shared-footer.css" />
    
    <style>
        /* Page content styles only - no header overrides */
        html, body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Inter', sans-serif;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .cinema-movie-management {
            background: #0a0a0a;
            min-height: calc(100vh - 80px);
            padding-top: 0;
            display: flex;
            flex-direction: column;
        }
        
        .management-content {
            padding: 100px 0 20px 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .page-header {
            background: linear-gradient(135deg, #df2144 0%, #ff1e2b 100%);
            padding: 40px 0;
            margin-bottom: 40px;
            margin-top: 0;
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .page-header h1 {
            color: #fff;
            font-size: 3rem;
            font-weight: 800;
            margin: 0;
            text-align: center;
            font-family: 'Inter', sans-serif;
            position: relative;
            z-index: 2;
        }
        
        .page-header .breadcrumb {
            justify-content: center;
            background: transparent;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }
        
        .page-header .breadcrumb-item {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .page-header .breadcrumb-item + .breadcrumb-item::before {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .page-header .breadcrumb-item.active {
            color: #fff;
            font-weight: 600;
        }
        
        .page-header .breadcrumb-item a {
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .page-header .breadcrumb-item a:hover {
            color: rgba(255, 255, 255, 1);
        }
        
        /* Movie management content styles */
        .controls-section {
            background: rgba(42, 42, 42, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 16px !important;
            padding: 32px !important;
            margin-bottom: 40px !important;
            backdrop-filter: blur(20px) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            z-index: 2;
        }
        
        .search-input {
            width: 100%;
            font-size: 16px !important;
            padding: 16px 20px 16px 50px !important;
            border-radius: 12px !important;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            color: white;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: rgba(223, 33, 68, 0.6) !important;
            box-shadow: 0 0 0 4px rgba(223, 33, 68, 0.2) !important;
            background: rgba(255, 255, 255, 0.12) !important;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-add-movie {
            background: linear-gradient(135deg, #df2144, #ff4466);
            border: none;
            color: white;
            font-size: 16px !important;
            padding: 16px 32px !important;
            border-radius: 12px !important;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(223, 33, 68, 0.3) !important;
            white-space: nowrap;
        }
        
        .btn-add-movie:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 35px rgba(223, 33, 68, 0.5) !important;
        }
        
        .movie-table-container {
            background: rgba(42, 42, 42, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 20px !important;
            overflow: hidden !important;
            backdrop-filter: blur(20px) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }

        .movie-table {
            width: 100%;
            border-collapse: collapse;
            color: white;
        }

        .movie-table th {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .movie-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        .movie-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Loading overlay styles */
        .movie-table-container.loading {
            position: relative;
            transition: opacity 0.2s ease;
            opacity: 0.7;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 10;
            border-radius: 20px;
        }
        
        .loading-spinner-small {
            background-color: rgba(42, 42, 42, 0.9);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(223, 33, 68, 0.3);
            border: 2px solid rgba(223, 33, 68, 0.2);
        }
        
        .loading-spinner-small i {
            color: #df2144;
            font-size: 24px;
        }
        
        /* Pagination styles */
        .pagination-container {
            background: rgba(42, 42, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-pagination {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-pagination:hover:not(:disabled) {
            background: rgba(223, 33, 68, 0.2);
            border-color: rgba(223, 33, 68, 0.5);
        }
        
        .btn-pagination.btn-active {
            background: rgba(223, 33, 68, 0.5);
            transform: scale(0.95);
            transition: all 0.1s ease;
        }

        .btn-pagination:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .mini-loading {
            margin-left: 8px;
            color: rgba(223, 33, 68, 0.8);
            animation: fadeIn 0.3s ease;
        }
        
        @@keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-number:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .page-number.active {
            background: #df2144;
            font-weight: bold;
        }
        
        .page-ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
            margin: 0 2px;
        }

        .pagination-size .form-select {
            background: rgba(42, 42, 42, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(223, 33, 68, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            width: 100px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .pagination-size .form-select option {
            background-color: #2a2a2a;
            color: white;
        }

        .movie-poster {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .movie-info {
            max-width: 200px;
        }

        .movie-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
        }

        .movie-studio {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .genre-tag {
            background: rgba(223, 33, 68, 0.2);
            color: #df2144;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-dropdown {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 0.85rem;
        }

        .status-dropdown:focus {
            border-color: #df2144;
            outline: none;
        }

        .status-dropdown option {
            background: #2a2a2a;
            color: white;
        }

        .toggle-switch {
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #df2144;
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        .rating-input {
            width: 70px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px;
            color: white;
            text-align: center;
        }

        .rating-input:focus {
            border-color: #df2144;
            outline: none;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-view {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .btn-view:hover {
            background: #3498db;
            color: white;
        }

        .btn-edit {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .btn-edit:hover {
            background: #f1c40f;
            color: #333;
        }

        .btn-delete {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .btn-delete:hover {
            background: #e74c3c;
            color: white;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .loading-spinner i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #121212;
            margin: 5% auto;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #df2144, #ff4466);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            border-radius: 20px 20px 0 0;
            pointer-events: none;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        
        .modal-header h3 i {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.2);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            z-index: 5;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 0;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Modern Movie Detail Styles */
        .movie-detail-modern {
            position: relative;
            width: 100%;
            color: white;
        }
        
        .movie-detail-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background-size: cover;
            background-position: center top;
            z-index: 0;
        }
        
        .movie-detail-content {
            position: relative;
            z-index: 1;
            padding: 30px;
        }
        
        .movie-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .movie-detail-poster-wrapper {
            position: relative;
            flex-shrink: 0;
            margin-top: 50px;
        }
        
        .movie-detail-poster {
            width: 220px;
            height: 330px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .movie-status {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .status-active {
            background: #4CAF50;
            color: white;
        }
        
        .status-coming {
            background: #2196F3;
            color: white;
        }
        
        .status-stopped {
            background: #F44336;
            color: white;
        }
        
        .movie-detail-info {
            flex: 1;
            padding-top: 120px;
        }
        
        .movie-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .movie-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            flex-wrap: wrap;
        }
        
        .movie-year, .movie-runtime {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .movie-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rating-stars {
            color: #FFC107;
            letter-spacing: 2px;
        }
        
        .rating-number {
            font-weight: 600;
        }
        
        .movie-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .movie-genre-pill {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: white;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .movie-genre-pill:hover {
            background: rgba(223, 33, 68, 0.2);
            border-color: rgba(223, 33, 68, 0.4);
        }
        
        .movie-tags {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .movie-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .movie-tag.featured {
            background: rgba(223, 33, 68, 0.2);
            color: #ff4466;
            border: 1px solid rgba(223, 33, 68, 0.3);
        }
        
        .movie-tag.recommended {
            background: rgba(33, 150, 243, 0.2);
            color: #64B5F6;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        .movie-overview {
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            max-width: 700px;
        }
        
        .movie-detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-grid-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 500;
            color: white;
        }
        
        .movie-trailer-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .trailer-container {
            position: relative;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trailer-embed-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #000;
        }
        
        .trailer-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            z-index: 1;
        }
        
        .trailer-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #df2144, #ff4466);
            z-index: 2;
        }
        
        .trailer-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 2;
        }
        
        /* Responsive Styles for Movie Detail */
        @@media (max-width: 768px) {
            .movie-detail-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .movie-detail-poster-wrapper {
                margin-top: 100px;
            }
            
            .movie-detail-info {
                padding-top: 20px;
            }
            
            .movie-title {
                font-size: 2rem;
            }
            
            .movie-meta, .movie-genres, .movie-tags {
                justify-content: center;
            }
            
            .movie-detail-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Footer styling override */
        .cinema-footer {
            margin-top: auto !important;
            position: relative !important;
            clear: both;
            width: 100% !important;
            flex-shrink: 0 !important;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .controls-header {
                flex-direction: column;
                gap: 1rem;
            }

            .search-box {
                min-width: auto;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .movie-table {
                font-size: 0.85rem;
            }

            .movie-table th,
            .movie-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="cinema-movie-management">
                @{
            ViewBag.CurrentPage = "MovieManagement";
        }
        
        <!-- Header - Unified Dashboard Style -->
        @Html.Partial("_DashboardHeader")
        
    <!-- Main Content -->
        <div class="management-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <h1 id="movieListTitle"><i class="fas fa-film me-3"></i>Quản lý phim</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/" style="color: rgba(255, 255, 255, 0.8);">
                                <i class="fas fa-home"></i> Trang chủ
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/Dashboard" style="color: rgba(255, 255, 255, 0.8);">
                                Dashboard
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Quản lý phim</li>
                    </ol>
                </nav>
                        </div>
                </div>

            <div class="container-fluid px-4">


        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-header">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Tìm kiếm phim theo tên..." id="movieSearch">
                </div>
                <button class="btn-add-movie" onclick="openAddMovieModal()">
                        <i class="fas fa-plus"></i>
                        Thêm phim mới
                    </button>
                </div>
            </div>

        <!-- Movies Table -->
        <div class="movie-table-container">
            <table class="movie-table">
                <thead>
                    <tr>
                        <th>POSTER</th>
                        <th>THÔNG TIN PHIM</th>
                        <th>THỂ LOẠI</th>
                        <th>NGÀY PHÁT HÀNH</th>
                        <th>THỜI LƯỢNG</th>
                        <th>TRẠNG THÁI</th>
                        <th>PHIM NỔI BẬT</th>
                        <th>PHIM ĐỀ XUẤT</th>
                        <th>RATING</th>
                        <th>HÀNH ĐỘNG</th>
                    </tr>
                </thead>
                <tbody id="movieTableBody">
                    <tr>
                        <td colspan="10" class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Đang tải dữ liệu...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination UI -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">Đang tải...</span>
            </div>
            <div class="pagination-controls">
                <button id="prevPageBtn" class="btn-pagination" disabled>❮ Trước</button>
                <div id="pageNumbers" class="page-numbers"></div>
                <button id="nextPageBtn" class="btn-pagination" disabled>Sau ❯</button>
            </div>
            <div class="pagination-size">
                <select id="pageSizeSelect" class="form-select">
                    <option value="5">5/trang</option>
                    <option value="10" selected>10/trang</option>
                    <option value="25">25/trang</option>
                    <option value="50">50/trang</option>
                </select>
            </div>
                    </div>
                    </div>
                </div>
                
<!-- Anti-forgery token for AJAX requests -->
@Html.AntiForgeryToken()

<!-- Movie Detail Modal -->
<div id="movieDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-film"></i> Chi tiết phim</h3>
            <span class="modal-close" onclick="closeModal('movieDetailModal')">&times;</span>
                    </div>
        <div class="modal-body">
            <!-- Content will be populated by JavaScript -->
                </div>
                    </div>
                </div>
                
<!-- Edit Movie Modal -->
<div id="editMovieModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Chỉnh sửa phim</h3>
            <span class="modal-close" onclick="closeModal('editMovieModal')">&times;</span>
                    </div>
        <div class="modal-body">
            <!-- Content will be populated by JavaScript -->
                </div>
            </div>
                </div>
            </div>

            </div>
                        </div>
        
        <!-- Footer -->
        @await Html.PartialAsync("footer")
                        
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    
    <!-- Anti-forgery token for AJAX requests -->
    @Html.AntiForgeryToken()
    
    <script>
        // API Base URL
        const API_BASE = '/api/v1';
        let movies = [];
        
        // Variables for pagination
        let currentPage = 1;
        let pageSize = 10;
        let totalMovies = 0;
        let totalPages = 0;

        // Load movies on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial page
            loadMoviesPage(currentPage, pageSize);
            
            // Event listener for page size change - thêm debounce
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        let pageSizeChangeTimeout;
        
        pageSizeSelect.addEventListener('change', function() {
            clearTimeout(pageSizeChangeTimeout);
            
            // Hiển thị loading nhỏ bên cạnh dropdown để biết đang xử lý
            const pageSizeContainer = this.closest('.pagination-size');
            const loadingIcon = document.createElement('span');
            loadingIcon.className = 'mini-loading';
            loadingIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Thêm icon loading và xóa icon loading cũ nếu có
            const existingLoading = pageSizeContainer.querySelector('.mini-loading');
            if (existingLoading) {
                existingLoading.remove();
            }
            pageSizeContainer.appendChild(loadingIcon);
            
            pageSizeChangeTimeout = setTimeout(() => {
                pageSize = parseInt(this.value);
                currentPage = 1; // Reset to first page
                loadMoviesPage(currentPage, pageSize);
                
                // Xóa icon loading sau 1 giây
                setTimeout(() => {
                    if (loadingIcon.parentNode) {
                        loadingIcon.remove();
                    }
                }, 1000);
            }, 300); // Debounce 300ms
        });
        
        // Event listeners for pagination buttons - thêm visual feedback
        document.getElementById('prevPageBtn').addEventListener('click', function() {
            if (currentPage > 1) {
                this.classList.add('btn-active');
                setTimeout(() => this.classList.remove('btn-active'), 200);
                
                currentPage--;
                loadMoviesPage(currentPage, pageSize);
            }
        });
        
        document.getElementById('nextPageBtn').addEventListener('click', function() {
            if (currentPage < totalPages) {
                this.classList.add('btn-active');
                setTimeout(() => this.classList.remove('btn-active'), 200);
                
                currentPage++;
                loadMoviesPage(currentPage, pageSize);
            }
        });
        
        // Event listener for search - debounce implementation
        const searchInput = document.getElementById('movieSearch');
        let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // Reset to first page when searching
                    currentPage = 1;
                    loadMoviesPage(currentPage, pageSize, this.value.trim());
                }, 500); // 500ms debounce delay
            });
            
            // Add event listeners for toggle switches
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('toggle-switch')) {
                    const movieId = e.target.getAttribute('data-movie-id');
                    const currentState = e.target.getAttribute('data-current-state') === 'true';
                    const type = e.target.getAttribute('data-type');
                    
                    if (type === 'featured') {
                        toggleFeatured(movieId, !currentState);
                    } else if (type === 'recommended') {
                        toggleRecommended(movieId, !currentState);
                    }
                }
            });
        });

        // Biến để theo dõi lần gọi API mới nhất và tránh spam API
        let currentApiCall = 0;
        let isLoadingData = false;
        let lastAPICallTime = 0;
        const API_COOLDOWN = 500; // 500ms cooldown giữa các lần gọi API

        // Load movies from pagination API using controller
        async function loadMoviesPage(page, pageSize, searchTerm = '') {
            try {
                // Tránh gọi API liên tục, thêm cooldown
                const now = Date.now();
                if (isLoadingData || (now - lastAPICallTime < API_COOLDOWN)) {
                    console.log('Skipping API call - too frequent or already loading');
                    return;
                }
                
                // Đánh dấu đang loading
                isLoadingData = true;
                lastAPICallTime = now;
                
                const tbody = document.getElementById('movieTableBody');
                const thisApiCall = ++currentApiCall; // Mỗi lần gọi API sẽ có một ID duy nhất
                
                // Hiển thị animation loading và giữ lại nội dung cũ với opacity thấp hơn
                const tableContainer = document.querySelector('.movie-table-container');
                
                // Xoá overlay loading cũ nếu có
                const oldOverlay = tableContainer.querySelector('.loading-overlay');
                if (oldOverlay) {
                    oldOverlay.remove();
                }
                
                // Thêm class loading để hiệu ứng mờ
                tableContainer.classList.add('loading');
                
                // Thêm overlay loading indicator
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="loading-spinner-small">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                `;
                tableContainer.appendChild(loadingOverlay);
                
                console.log(`Loading movies - Page: ${page}, PageSize: ${pageSize}, Search: "${searchTerm}"`);
                
                // Build query URL
                let url = `/MovieManagement/Movies/GetMoviesPagination?page=${page}&pageSize=${pageSize}`;
                if (searchTerm) {
                    url += `&searchTerm=${encodeURIComponent(searchTerm)}`;
                }
                
                // Thêm timestamp để tránh cache
                url += `&_=${Date.now()}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);

                    // Log chi tiết cấu trúc API để debug
                    if (result.success && result.data) {
                        console.log('API Response Structure:');
                        if (result.data.data && Array.isArray(result.data.data) && result.data.data.length > 0) {
                            const firstMovie = result.data.data[0];
                            console.log('First movie structure:', firstMovie);
                            console.log('First movie has primaryImageUrl:', !!firstMovie.primaryImageUrl);
                            console.log('First movie has PrimaryImageUrl:', !!firstMovie.PrimaryImageUrl);
                            console.log('First movie has images array:', !!firstMovie.images && Array.isArray(firstMovie.images));
                            console.log('First movie has Images array:', !!firstMovie.Images && Array.isArray(firstMovie.Images));

                            if (firstMovie.images && firstMovie.images.length > 0) {
                                console.log('First image in images array:', firstMovie.images[0]);
                            }
                            if (firstMovie.Images && firstMovie.Images.length > 0) {
                                console.log('First image in Images array:', firstMovie.Images[0]);
                            }
                        }
                    }
                    
                    // Kiểm tra nếu API call này đã bị thay thế bởi call mới hơn
                    if (thisApiCall < currentApiCall) {
                        console.log(`Ignoring stale API response for call #${thisApiCall}`);
                        return;
                    }
                    
                    if (result.success && result.data) {
                        // Check if response has proper pagination data structure
                        if (result.data.data) {
                            // Response format: { data: { data: [...], total: X, page: Y, pageSize: Z } }
                            movies = result.data.data || [];
                            totalMovies = result.data.total || 0;
                            currentPage = result.data.page || page;
                            pageSize = result.data.pageSize || pageSize;
                    } else {
                            // Legacy format without pagination info
                            movies = result.data;
                            totalMovies = movies.length;
                            currentPage = page;
                        }
                        
                        // Calculate total pages
                        totalPages = Math.max(1, Math.ceil(totalMovies / pageSize));
                        
                        console.log(`Loaded ${movies.length} movies (Page ${currentPage}/${totalPages}, Total: ${totalMovies})`);
                        
                        // Update UI
                        updatePaginationInfo();
                        renderPageNumbers();
                    updateMovieHeader();
                    renderMovies();
                        
                        // Update button states
                        document.getElementById('prevPageBtn').disabled = (currentPage <= 1);
                        document.getElementById('nextPageBtn').disabled = (currentPage >= totalPages);
                    } else {
                        console.error('Controller returned error:', result.message);
                        movies = [];
                        showEmptyState('Không thể tải dữ liệu phim. ' + (result.message || ''));
                    }
                    
                    // Xóa overlay loading và class loading
                    const tableContainer = document.querySelector('.movie-table-container');
                    const loadingOverlay = tableContainer.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }
                    tableContainer.classList.remove('loading');
                    
                    // Reset loading flag
                    isLoadingData = false;
                } else {
                    console.error('Controller Error:', response.status);
                    showEmptyState('Không thể tải dữ liệu phim. Vui lòng thử lại.');
                    
                    // Xóa overlay loading và class loading
                    const tableContainer = document.querySelector('.movie-table-container');
                    const loadingOverlay = tableContainer.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }
                    tableContainer.classList.remove('loading');
                    
                    // Reset loading flag
                    isLoadingData = false;
                }
            } catch (error) {
                console.error('Error loading movies:', error);
                showEmptyState('Không thể tải dữ liệu phim. Vui lòng thử lại.');
                
                // Xóa overlay loading và class loading
                const tableContainer = document.querySelector('.movie-table-container');
                const loadingOverlay = tableContainer.querySelector('.loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
                tableContainer.classList.remove('loading');
                
                // Reset loading flag
                isLoadingData = false;
            }
        }

        // Update movie header with count - exactly like the image
        function updateMovieHeader() {
            const headerTitle = document.getElementById('movieListTitle');
            headerTitle.innerHTML = `<i class="fas fa-film me-2"></i>Danh sách phim (${totalMovies} phim)`;
            
            // Debug log
            console.log(`Loaded ${movies.length} movies (total: ${totalMovies}) successfully`);
        }
        
        // Hàm lấy đường dẫn ảnh từ thông tin phim
        // Hàm chuyển đổi URL thường thành URL embed cho trailer
        function getEmbedUrl(url) {
            if (!url) return '';
            
            // Xử lý URL YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                // Lấy video ID từ URL YouTube
                let videoId = '';
                
                if (url.includes('youtube.com/watch')) {
                    const urlParams = new URLSearchParams(new URL(url).search);
                    videoId = urlParams.get('v');
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/embed/')) {
                    videoId = url.split('youtube.com/embed/')[1].split('?')[0];
                }
                
                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0`;
                }
            }
            
            // Xử lý URL Cloudinary
            if (url.includes('cloudinary.com')) {
                // Nếu đã là URL embed, trả về nguyên URL
                if (url.includes('/embed')) {
                    return url;
                }
                
                // Chuyển đổi URL thường sang URL embed
                if (url.includes('/video/upload/')) {
                    return url.replace('/video/upload/', '/video/upload/e_volume:0/');
                }
            }
            
            // Xử lý URL Vimeo
            if (url.includes('vimeo.com')) {
                const vimeoId = url.split('vimeo.com/')[1];
                if (vimeoId) {
                    return `https://player.vimeo.com/video/${vimeoId}`;
                }
            }
            
            // Nếu không phải các loại URL trên, trả về URL gốc
            return url;
        }
        
        function getMovieImageUrl(movie) {
            // Kiểm tra theo thứ tự ưu tiên
            // 1. primaryImageUrl
            if (movie.primaryImageUrl) {
                console.log(`Movie ${movie.title}: Using primaryImageUrl: ${movie.primaryImageUrl}`);
                return movie.primaryImageUrl;
            }
            
            // 2. PrimaryImageUrl (Pascal case)
            if (movie.PrimaryImageUrl) {
                console.log(`Movie ${movie.title}: Using PrimaryImageUrl: ${movie.PrimaryImageUrl}`);
                return movie.PrimaryImageUrl;
            }
            
            // 3. Tìm trong mảng images nếu có isPrimary = true
            if (movie.images && Array.isArray(movie.images) && movie.images.length > 0) {
                // Tìm ảnh có isPrimary = true
                const primaryImage = movie.images.find(img => img.isPrimary === true);
                if (primaryImage && primaryImage.imageUrl) {
                    console.log(`Movie ${movie.title}: Using images array with isPrimary: ${primaryImage.imageUrl}`);
                    return primaryImage.imageUrl;
                }
                
                // Nếu không có isPrimary, lấy ảnh đầu tiên
                if (movie.images[0].imageUrl) {
                    console.log(`Movie ${movie.title}: Using first image: ${movie.images[0].imageUrl}`);
                    return movie.images[0].imageUrl;
                }
            }
            
            // 4. Tìm trong mảng Images (Pascal case) nếu có IsPrimary = true
            if (movie.Images && Array.isArray(movie.Images) && movie.Images.length > 0) {
                // Tìm ảnh có IsPrimary = true
                const primaryImage = movie.Images.find(img => img.IsPrimary === true || img.isPrimary === true);
                if (primaryImage) {
                    const url = primaryImage.ImageUrl || primaryImage.imageUrl;
                    if (url) {
                        console.log(`Movie ${movie.title}: Using Images array with IsPrimary: ${url}`);
                        return url;
                    }
                }
                
                // Nếu không có IsPrimary, lấy ảnh đầu tiên
                const firstImageUrl = movie.Images[0].ImageUrl || movie.Images[0].imageUrl;
                if (firstImageUrl) {
                    console.log(`Movie ${movie.title}: Using first Image (Pascal): ${firstImageUrl}`);
                    return firstImageUrl;
                }
            }
            
            // 5. Kiểm tra imageUrl nếu có
            if (movie.imageUrl) {
                console.log(`Movie ${movie.title}: Using imageUrl: ${movie.imageUrl}`);
                return movie.imageUrl;
            }
            
            // 6. Kiểm tra posterUrl nếu có
            if (movie.posterUrl) {
                console.log(`Movie ${movie.title}: Using posterUrl: ${movie.posterUrl}`);
                return movie.posterUrl;
            }
            
            // 7. Cuối cùng trả về ảnh placeholder
            console.log(`Movie ${movie.title}: No image found, using placeholder`);
            return 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'80\' viewBox=\'0 0 60 80\' fill=\'none\'%3E%3Crect width=\'60\' height=\'80\' fill=\'%232a2a2a\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'8\' fill=\'%23666\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo image%3C/text%3E%3C/svg%3E';
        }
        
        // Update pagination info text
        function updatePaginationInfo() {
            const infoElement = document.getElementById('paginationInfo');
            
            if (totalMovies === 0) {
                infoElement.textContent = "Không có phim nào";
                return;
            }
            
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalMovies);
            
            infoElement.textContent = `Trang ${currentPage}/${totalPages} (Hiển thị ${startItem}-${endItem} của ${totalMovies})`;
        }
        
        // Render page number buttons
        function renderPageNumbers() {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Calculate range of page numbers to display
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Always show at least 5 pages if available
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(5, totalPages);
                } else {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            // First page button if not in view
            if (startPage > 1) {
                const firstPageBtn = document.createElement('div');
                firstPageBtn.className = 'page-number';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    currentPage = 1;
                    loadMoviesPage(currentPage, pageSize);
                });
                pageNumbersContainer.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'page-ellipsis';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }
            
            // Page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = i === currentPage ? 'page-number active' : 'page-number';
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    if (i !== currentPage) {
                        currentPage = i;
                        loadMoviesPage(currentPage, pageSize);
                    }
                });
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // Last page button if not in view
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'page-ellipsis';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('div');
                lastPageBtn.className = 'page-number';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    currentPage = totalPages;
                    loadMoviesPage(currentPage, pageSize);
                });
                pageNumbersContainer.appendChild(lastPageBtn);
            }
        }

        // Render movies table
        function renderMovies() {
            const tbody = document.getElementById('movieTableBody');
            
            if (movies.length === 0) {
                showEmptyState();
                return;
            }
            
            tbody.innerHTML = movies.map(movie => {
                const statusText = getStatusText(movie.status);
                const genresText = Array.isArray(movie.genres) && movie.genres.length > 0 
                    ? movie.genres.join(', ') 
                    : 'Chưa phân loại';
                
                return `
                <tr data-movie-id="${movie.id}">
                    <td>
                        <img src="${getMovieImageUrl(movie)}" 
                             alt="${movie.title}" 
                             class="movie-poster"
                             loading="lazy"
                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'80\' viewBox=\'0 0 60 80\' fill=\'none\'%3E%3Crect width=\'60\' height=\'80\' fill=\'%232a2a2a\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'8\' fill=\'%23666\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo image%3C/text%3E%3C/svg%3E'">
                                        </td>
                    <td>
                        <div class="movie-info">
                            <div class="movie-title">${movie.title || 'N/A'}</div>
                            <div class="movie-studio">${movie.productionCompany || 'Chưa có thông tin'}</div>
                                            </div>
                                        </td>
                    <td>
                        <div class="movie-genres">
                            <span class="genre-tag">${genresText}</span>
                                                </div>
                                        </td>
                    <td>${movie.releaseDate ? new Date(movie.releaseDate).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td>${movie.runningTime ? movie.runningTime + ' phút' : 'N/A'}</td>
                    <td>
                        <select class="status-dropdown" onchange="changeMovieStatus('${movie.id}', this.value)">
                            <option value="2" ${movie.status === 2 ? 'selected' : ''}>Đang chiếu</option>
                            <option value="1" ${movie.status === 1 ? 'selected' : ''}>Sắp chiếu</option>
                            <option value="3" ${movie.status === 3 ? 'selected' : ''}>Ngừng chiếu</option>
                            <option value="0" ${movie.status === 0 ? 'selected' : ''}>Chưa có</option>
                        </select>
                                        </td>
                    <td>
                        <button class="toggle-switch ${movie.isFeatured ? 'active' : ''}" 
                                data-movie-id="${movie.id}" 
                                data-current-state="${movie.isFeatured}" 
                                data-type="featured">
                        </button>
                                        </td>
                    <td>
                        <button class="toggle-switch ${movie.isRecommended ? 'active' : ''}" 
                                data-movie-id="${movie.id}" 
                                data-current-state="${movie.isRecommended}" 
                                data-type="recommended">
                        </button>
                                        </td>
                    <td>
                        <input type="number" class="rating-input" 
                               value="${movie.rating || 0}" 
                               min="0" max="10" step="0.1"
                               onchange="updateRating('${movie.id}', this.value)">
                                        </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" title="Xem chi tiết" onclick="viewMovie('${movie.id}')">
                                                    <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" title="Chỉnh sửa" onclick="editMovie('${movie.id}')">
                                                    <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" title="Xóa" onclick="deleteMovie('${movie.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
            `;
            }).join('');
        }

        // Helper function to get status text
        function getStatusText(status) {
            switch(status) {
                case 2: return 'Đang chiếu';    // NowShowing
                case 1: return 'Sắp chiếu';     // ComingSoon
                case 3: return 'Ngừng chiếu';   // Stopped
                case 0: return 'Chưa có';       // NotAvailable
                default: return 'Không xác định';
            }
        }

        // Action functions 
        async function changeMovieStatus(movieId, status) {
            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                
                const response = await fetch(`/MovieManagement/Movies/ChangeMovieStatus?movieId=${movieId}&status=${status}`, {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(result.message, 'success');
                    // Update the movie in local array
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        movie.status = parseInt(status);
                    }
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error changing status:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật trạng thái', 'error');
            }
        }

        async function toggleFeatured(movieId, isFeatured) {
            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                
                const response = await fetch(`/MovieManagement/Movies/SetFeatured?movieId=${movieId}&isFeatured=${isFeatured}`, {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(result.message, 'success');
                    // Update the movie in local array
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        movie.isFeatured = isFeatured;
                    }
                    // Update the toggle button
                    const toggleBtn = document.querySelector(`button[data-movie-id="${movieId}"][data-type="featured"]`);
                    if (toggleBtn) {
                        toggleBtn.className = `toggle-switch ${isFeatured ? 'active' : ''}`;
                        toggleBtn.setAttribute('data-current-state', isFeatured);
                    }
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error toggling featured:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật trạng thái nổi bật', 'error');
            }
        }

        async function toggleRecommended(movieId, isRecommended) {
            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                
                const response = await fetch(`/MovieManagement/Movies/SetRecommended?movieId=${movieId}&isRecommended=${isRecommended}`, {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(result.message, 'success');
                    // Update the movie in local array
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        movie.isRecommended = isRecommended;
                    }
                    // Update the toggle button
                    const toggleBtn = document.querySelector(`button[data-movie-id="${movieId}"][data-type="recommended"]`);
                    if (toggleBtn) {
                        toggleBtn.className = `toggle-switch ${isRecommended ? 'active' : ''}`;
                        toggleBtn.setAttribute('data-current-state', isRecommended);
                    }
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error toggling recommended:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật trạng thái đề xuất', 'error');
            }
        }

        async function updateRating(movieId, rating) {
            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                
                const response = await fetch(`/MovieManagement/Movies/UpdateRating?movieId=${movieId}&rating=${rating}`, {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(result.message, 'success');
                    // Update the movie in local array
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        movie.rating = parseFloat(rating);
                    }
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error updating rating:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật rating', 'error');
            }
        }

        async function viewMovie(movieId) {
            try {
                const response = await fetch(`/MovieManagement/Movies/GetMovieById?movieId=${movieId}`);
                const result = await response.json();
                
                console.log('View Movie API Response:', result); // Debug log
                
                if (result.success) {
                    // Check if data is nested under .data property
                    const movieData = result.data?.data || result.data;
                    console.log('Movie Data for View:', movieData); // Debug log
                    
                    if (movieData) {
                        showMovieDetailModal(movieData);
                    } else {
                        showNotification('Không có dữ liệu phim', 'error');
                    }
                } else {
                    showNotification('Không thể tải thông tin phim', 'error');
                }
            } catch (error) {
                console.error('Error loading movie details:', error);
                showNotification('Đã xảy ra lỗi khi tải thông tin phim', 'error');
            }
        }

        async function editMovie(movieId) {
            try {
                const response = await fetch(`/MovieManagement/Movies/GetMovieById?movieId=${movieId}`);
                const result = await response.json();
                
                console.log('Edit Movie API Response:', result); // Debug log
                
                if (result.success) {
                    // Check if data is nested under .data property
                    const movieData = result.data?.data || result.data;
                    console.log('Movie Data for Edit:', movieData); // Debug log
                    
                    if (movieData) {
                        showEditMovieModal(movieData);
                    } else {
                        showNotification('Không có dữ liệu phim để chỉnh sửa', 'error');
                    }
                } else {
                    showNotification('Không thể tải thông tin phim để chỉnh sửa', 'error');
                }
            } catch (error) {
                console.error('Error loading movie for edit:', error);
                showNotification('Đã xảy ra lỗi khi tải thông tin phim', 'error');
            }
        }

        function deleteMovie(movieId) {
            console.log(`Deleting movie ${movieId}`);
            // TODO: Implement delete movie functionality if needed
        }

        // Notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Show empty state
        function showEmptyState(message = 'Chưa có phim nào trong hệ thống') {
            const tbody = document.getElementById('movieTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="empty-state">
                        <i class="fas fa-film"></i>
                        <h3>Không có dữ liệu</h3>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        function openAddMovieModal() {
            alert('Chức năng thêm phim sẽ được triển khai sau');
        }

        // Modal functions
        function showMovieDetailModal(movieData) {
            console.log('Showing detail modal with data:', movieData); // Debug log
            
            const modal = document.getElementById('movieDetailModal');
            const modalBody = modal.querySelector('.modal-body');
            
            // Handle different possible data structures
            const title = movieData.title || movieData.Title || 'Không có tiêu đề';
            const director = movieData.director || movieData.Director || 'N/A';
            const actors = movieData.actors || movieData.Actors || 'N/A';
            const productionCompany = movieData.productionCompany || movieData.ProductionCompany || 'N/A';
            const runningTime = movieData.runningTime || movieData.RunningTime || 'N/A';
            const releaseDate = movieData.releaseDate || movieData.ReleaseDate;
            const status = movieData.status || movieData.Status || 0;
            const rating = movieData.rating || movieData.Rating || 0;
            const content = movieData.content || movieData.Content || 'Chưa có mô tả';
            const trailerUrl = movieData.trailerUrl || movieData.TrailerUrl;
            const isFeatured = movieData.isFeatured || movieData.IsFeatured || false;
            const isRecommended = movieData.isRecommended || movieData.IsRecommended || false;
            
            // Get image URL using our helper function
            const posterUrl = getMovieImageUrl(movieData);
            
            // Get genres
            let genresHtml = '';
            if (movieData.genres && Array.isArray(movieData.genres) && movieData.genres.length > 0) {
                genresHtml = movieData.genres.map(g => 
                    `<span class="movie-genre-pill">${g.name || g.Name || ''}</span>`
                ).join('');
            } else if (movieData.Genres && Array.isArray(movieData.Genres) && movieData.Genres.length > 0) {
                genresHtml = movieData.Genres.map(g => 
                    `<span class="movie-genre-pill">${g.name || g.Name || ''}</span>`
                ).join('');
            } else {
                genresHtml = '<span class="movie-genre-pill">Chưa phân loại</span>';
            }
            
            // Calculate rating stars
            const ratingValue = parseFloat(rating) || 0;
            const fullStars = Math.floor(ratingValue);
            const halfStar = ratingValue % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                starsHtml += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i class="far fa-star"></i>';
            }
            
            // Get status badge class
            const statusClass = status === 2 ? 'status-active' : (status === 1 ? 'status-coming' : 'status-stopped');
            const statusIcon = status === 2 ? 'fa-play-circle' : (status === 1 ? 'fa-clock' : 'fa-stop-circle');
            
            modalBody.innerHTML = `
                <div class="movie-detail-modern">
                    <div class="movie-detail-backdrop" style="background-image: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(18,18,18,1) 100%), url('${posterUrl}');"></div>
                    
                <div class="movie-detail-content">
                    <div class="movie-detail-header">
                            <div class="movie-detail-poster-wrapper">
                        <img src="${posterUrl}" 
                             alt="${title}" class="movie-detail-poster"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'300\' viewBox=\'0 0 200 300\' fill=\'none\'%3E%3Crect width=\'200\' height=\'300\' fill=\'%232a2a2a\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'14\' fill=\'%23666\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo poster available%3C/text%3E%3C/svg%3E'">
                                
                                <div class="movie-status ${statusClass}">
                                    <i class="fas ${statusIcon}"></i> ${getStatusText(status)}
                                </div>
                            </div>
                            
                        <div class="movie-detail-info">
                                <h1 class="movie-title">${title}</h1>
                                
                                <div class="movie-meta">
                                    <div class="movie-year">
                                        <i class="far fa-calendar-alt"></i>
                                        ${releaseDate ? new Date(releaseDate).getFullYear() : 'N/A'}
                                    </div>
                                    <div class="movie-runtime">
                                        <i class="far fa-clock"></i>
                                        ${runningTime} phút
                                </div>
                                    <div class="movie-rating">
                                        <div class="rating-stars">
                                            ${starsHtml}
                            </div>
                                        <div class="rating-number">
                                            ${ratingValue.toFixed(1)}/10
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="movie-genres">
                                    ${genresHtml}
                                </div>
                                
                                <div class="movie-tags">
                                    ${isFeatured ? '<span class="movie-tag featured"><i class="fas fa-certificate"></i> Nổi bật</span>' : ''}
                                    ${isRecommended ? '<span class="movie-tag recommended"><i class="fas fa-thumbs-up"></i> Đề xuất</span>' : ''}
                                </div>
                                
                                <div class="movie-overview">
                        <p>${content}</p>
                    </div>
                            </div>
                        </div>
                        
                        <div class="movie-detail-info-grid">
                            <div class="info-grid-item">
                                <div class="info-label">Đạo diễn</div>
                                <div class="info-value">${director}</div>
                            </div>
                            <div class="info-grid-item">
                                <div class="info-label">Diễn viên</div>
                                <div class="info-value">${actors}</div>
                            </div>
                            <div class="info-grid-item">
                                <div class="info-label">Công ty sản xuất</div>
                                <div class="info-value">${productionCompany}</div>
                            </div>
                            <div class="info-grid-item">
                                <div class="info-label">Ngày phát hành</div>
                                <div class="info-value">${releaseDate ? new Date(releaseDate).toLocaleDateString('vi-VN') : 'N/A'}</div>
                            </div>
                        </div>
                        
                    ${trailerUrl ? `
                        <div class="movie-trailer-section">
                            <h3 class="section-title"><i class="fas fa-film"></i> Trailer</h3>
                            <div class="trailer-container">
                                <div class="trailer-embed-wrapper">
                                    <iframe 
                                        src="${getEmbedUrl(trailerUrl)}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                        class="trailer-iframe">
                                    </iframe>
                                </div>
                            </div>
                    </div>
                    ` : ''}
                    </div>
            </div>
            `;
            
            modal.style.display = 'block';
        }

        function showEditMovieModal(movieData) {
            console.log('Showing edit modal with data:', movieData); // Debug log
            
            const modal = document.getElementById('editMovieModal');
            const modalBody = modal.querySelector('.modal-body');
            
            // Store original movie data for update
            modal.setAttribute('data-movie-data', JSON.stringify(movieData));
            
            // Handle different possible data structures
            const id = movieData.id || movieData.Id || '';
            const title = movieData.title || movieData.Title || '';
            const director = movieData.director || movieData.Director || '';
            const actors = movieData.actors || movieData.Actors || '';
            const productionCompany = movieData.productionCompany || movieData.ProductionCompany || '';
            const runningTime = movieData.runningTime || movieData.RunningTime || '';
            const releaseDate = movieData.releaseDate || movieData.ReleaseDate;
            const endDate = movieData.endDate || movieData.EndDate;
            const rating = movieData.rating || movieData.Rating || 0;
            const content = movieData.content || movieData.Content || '';
            const trailerUrl = movieData.trailerUrl || movieData.TrailerUrl || '';
            const isFeatured = movieData.isFeatured || movieData.IsFeatured || false;
            const isRecommended = movieData.isRecommended || movieData.IsRecommended || false;
            const version = movieData.version || movieData.Version || '2D';
            
            // Get image URL using our helper function
            const posterUrl = getMovieImageUrl(movieData);
            
            modalBody.innerHTML = `
                <form id="editMovieForm" onsubmit="updateMovie(event, '${id}')">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTitle">Tên phim</label>
                            <input type="text" id="editTitle" name="title" value="${title}" required>
                        </div>
                        <div class="form-group">
                            <label for="editReleaseDate">Ngày phát hành</label>
                            <input type="date" id="editReleaseDate" name="releaseDate" 
                                   value="${releaseDate ? releaseDate.split('T')[0] : ''}">
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEndDate">Ngày kết thúc</label>
                            <input type="date" id="editEndDate" name="endDate" 
                                   value="${endDate ? endDate.split('T')[0] : ''}">
                    </div>
                        <div class="form-group">
                            <label for="editProductionCompany">Hãng sản xuất</label>
                            <input type="text" id="editProductionCompany" name="productionCompany" value="${productionCompany}">
                    </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDirector">Đạo diễn</label>
                            <input type="text" id="editDirector" name="director" value="${director}">
                </div>
                        <div class="form-group">
                            <label for="editActors">Diễn viên</label>
                            <input type="text" id="editActors" name="actors" value="${actors}">
            </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRunningTime">Thời lượng (phút) *</label>
                            <input type="number" id="editRunningTime" name="runningTime" value="${runningTime}" min="1" required>
                </div>
                        <div class="form-group">
                            <label for="editVersion">Phiên bản *</label>
                            <select id="editVersion" name="version" required>
                                <option value="TwoD" ${(version === 1 || version === 'TwoD' || version === '2D') ? 'selected' : ''}>2D</option>
                                <option value="ThreeD" ${(version === 2 || version === 'ThreeD' || version === '3D') ? 'selected' : ''}>3D</option>
                                <option value="FourDX" ${(version === 3 || version === 'FourDX' || version === '4DX') ? 'selected' : ''}>4DX</option>
                            </select>
                    </div>
                </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRating">Rating</label>
                            <input type="number" id="editRating" name="rating" value="${rating}" 
                                   min="0" max="10" step="0.1">
            </div>
                        <div class="form-group">
                            <!-- Empty space for layout balance -->
            </div>
        </div>
                    
                    <div class="form-group full-width">
                        <label for="editContent">Mô tả phim</label>
                        <textarea id="editContent" name="content" rows="4" placeholder="Mô tả nội dung phim...">${content}</textarea>
                </div>
                    
                    <!-- Genres Selection -->
                    <div class="form-group full-width">
                        <label for="editGenres">Thể loại phim *</label>
                        <div class="genres-selection">
                            <div id="genreCheckboxes" class="genre-checkboxes">
                                <!-- Will be populated dynamically -->
                </div>
                        </div>
                        <small class="text-muted">Chọn ít nhất một thể loại</small>
                    </div>
                    
                    <!-- Show Times Section -->
                    <div class="form-group full-width">
                        <label>Lịch chiếu</label>
                        <div class="showtimes-section">
                            <div class="showtimes-header">
                                <button type="button" class="btn-add-showtime" onclick="addShowTimeEntry()">
                                    ➕ Thêm lịch chiếu
                    </button>
                            </div>
                            <div id="showTimesContainer" class="showtimes-container">
                                <!-- Showtimes will be added here -->
                            </div>
                        </div>
                        <small class="text-muted">Thêm ít nhất một lịch chiếu</small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="editTrailerUrl">Trailer</label>
                        <div class="trailer-upload-container">
                            <div class="upload-method-tabs">
                                <button type="button" class="tab-btn active" onclick="switchTrailerTab('url')">URL</button>
                                <button type="button" class="tab-btn" onclick="switchTrailerTab('upload')">Upload</button>
                            </div>
                            <div id="trailerUrlTab" class="upload-tab active">
                                <input type="url" id="editTrailerUrl" name="trailerUrl" value="${trailerUrl}" 
                                       placeholder="https://player.cloudinary.com/embed/?cloud_name=swp39imagel">
                            </div>
                            <div id="trailerUploadTab" class="upload-tab">
                                <input type="file" id="trailerFileInput" accept="video/*" style="display: none;">
                                <button type="button" class="btn-upload-file" onclick="document.getElementById('trailerFileInput').click()">
                                    📤 Chọn file video
                    </button>
                                <div id="trailerUploadProgress" class="upload-progress" style="display: none;">
                                    <div class="progress-bar"></div>
                                    <span class="progress-text">Đang upload...</span>
                </div>
                                <div id="trailerUploadResult" class="upload-result"></div>
            </div>
        </div>
                        <small class="text-muted">Hỗ trợ MP4, MOV, AVI, MKV, WEBM</small>
    </div>

                    <div class="form-group full-width">
                        <label>Hình ảnh phim</label>
                        
                        <!-- Poster chính -->
                        <div class="poster-upload-section">
                            <h4>Poster chính</h4>
                            <div class="image-upload-container">
                                <div class="upload-method-tabs">
                                    <button type="button" class="tab-btn active" onclick="switchPosterTab('url')">URL</button>
                                    <button type="button" class="tab-btn" onclick="switchPosterTab('upload')">Upload</button>
                                </div>
                                <div id="posterUrlTab" class="upload-tab active">
                                    <input type="url" id="editImageUrl" name="imageUrl" value="${posterUrl}" 
                                           placeholder="https://upload.wikimedia.org/wiki">
                                </div>
                                <div id="posterUploadTab" class="upload-tab">
                                    <input type="file" id="posterFileInput" accept="image/*" style="display: none;">
                                    <button type="button" class="btn-upload-file" onclick="document.getElementById('posterFileInput').click()">
                                        📤 Chọn hình ảnh
                                    </button>
                                    <div id="posterUploadProgress" class="upload-progress" style="display: none;">
                                        <div class="progress-bar"></div>
                                        <span class="progress-text">Đang upload...</span>
                                    </div>
                                </div>
                                <div class="image-preview">
                                    <img src="${posterUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'450\' viewBox=\'0 0 300 450\' fill=\'none\'%3E%3Crect width=\'300\' height=\'450\' fill=\'%232a2a2a\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'16\' fill=\'%23666\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EPoster image%3C/text%3E%3C/svg%3E'}" 
                                         alt="Poster preview" class="poster-preview" id="posterPreview"
                                         loading="lazy"
                                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'450\' viewBox=\'0 0 300 450\' fill=\'none\'%3E%3Crect width=\'300\' height=\'450\' fill=\'%232a2a2a\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'16\' fill=\'%23666\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EPoster image%3C/text%3E%3C/svg%3E'">
                                    <span class="poster-label">Poster chính</span>
                                    <div class="image-meta">
                                        <input type="text" id="posterDescription" name="posterDescription" placeholder="Mô tả hình ảnh..." class="image-description-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hình ảnh bổ sung -->
                        <div class="additional-images-section">
                            <h4>Hình ảnh bổ sung</h4>
                            <div class="additional-images-upload">
                                <input type="file" id="additionalImagesInput" accept="image/*" multiple style="display: none;">
                                <button type="button" class="btn-upload-multiple" onclick="document.getElementById('additionalImagesInput').click()">
                                    📤 Thêm nhiều hình ảnh
                                </button>
                                <div id="additionalUploadProgress" class="upload-progress" style="display: none;">
                                    <div class="progress-bar"></div>
                                    <span class="progress-text">Đang upload...</span>
                                </div>
                            </div>
                            <div id="additionalImagesContainer" class="additional-images-grid">
                                <!-- Additional images will be populated here -->
                            </div>
                        </div>
                        
                        <small class="text-muted">Hỗ trợ PNG, JPG, JPEG, GIF, WEBP. Có thể upload nhiều hình cùng lúc.</small>
                    </div>
                    
                    <div class="form-row checkbox-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editIsFeatured" name="isFeatured" ${isFeatured ? 'checked' : ''}>
                                <span class="checkmark"></span>
                                Phim nổi bật
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editIsRecommended" name="isRecommended" ${isRecommended ? 'checked' : ''}>
                                <span class="checkmark"></span>
                                Phim đề xuất
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal('editMovieModal')">Hủy</button>
                        <button type="submit" class="btn-save">🔄 Cập nhật phim</button>
                    </div>
                </form>
            `;
            
            // Add event listeners
            setupUploadEventListeners();
            
            // Load poster description
            loadPosterDescription(movieData);
            
            // Load existing additional images
            loadExistingAdditionalImages(movieData);
            
            // Load genres and rooms
            loadGenresAndRooms(movieData);
            
            modal.style.display = 'block';
        }

        function loadPosterDescription(movieData) {
            const posterDescInput = document.getElementById('posterDescription');
            if (posterDescInput && movieData.images) {
                const images = movieData.images || movieData.Images || [];
                const primaryImage = images.find(img => img.isPrimary || img.IsPrimary);
                if (primaryImage) {
                    const description = primaryImage.description || primaryImage.Description || '';
                    posterDescInput.value = description;
                }
            }
        }

        function loadExistingAdditionalImages(movieData) {
            const container = document.getElementById('additionalImagesContainer');
            container.innerHTML = ''; // Clear existing

            // Get all images except primary
            const allImages = [];
            if (movieData.images || movieData.Images) {
                const images = movieData.images || movieData.Images;
                if (Array.isArray(images)) {
                    images.forEach(img => {
                        const isPrimary = img.isPrimary || img.IsPrimary || false;
                        const imageUrl = img.imageUrl || img.ImageUrl || '';
                        const description = img.description || img.Description || '';
                        
                        if (!isPrimary && imageUrl) {
                            allImages.push({
                                url: imageUrl,
                                name: `Hình ảnh ${allImages.length + 1}`,
                                description: description
                            });
                        }
                    });
                }
            }

            // Display existing additional images
            if (allImages.length > 0) {
                displayAdditionalImages(allImages, container);
            }
        }

        // Setup all upload event listeners
        function setupUploadEventListeners() {
            // Poster URL input change
            const imageUrlInput = document.getElementById('editImageUrl');
            const posterPreview = document.getElementById('posterPreview');
            
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', function() {
                    if (this.value) {
                        posterPreview.src = this.value;
                        posterPreview.onerror = function() {
                            this.src = '/images/placeholder-movie.jpg';
                        };
                    }
                });
            }

            // Trailer file upload
            const trailerFileInput = document.getElementById('trailerFileInput');
            if (trailerFileInput) {
                trailerFileInput.addEventListener('change', handleTrailerUpload);
            }

            // Poster file upload
            const posterFileInput = document.getElementById('posterFileInput');
            if (posterFileInput) {
                posterFileInput.addEventListener('change', handlePosterUpload);
            }

            // Additional images upload
            const additionalImagesInput = document.getElementById('additionalImagesInput');
            if (additionalImagesInput) {
                additionalImagesInput.addEventListener('change', handleAdditionalImagesUpload);
            }
        }

        // Tab switching functions
        function switchTrailerTab(tab) {
            const urlTab = document.getElementById('trailerUrlTab');
            const uploadTab = document.getElementById('trailerUploadTab');
            const buttons = document.querySelectorAll('.trailer-upload-container .tab-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'url') {
                urlTab.classList.add('active');
                uploadTab.classList.remove('active');
                buttons[0].classList.add('active');
            } else {
                urlTab.classList.remove('active');
                uploadTab.classList.add('active');
                buttons[1].classList.add('active');
            }
        }

        function switchPosterTab(tab) {
            const urlTab = document.getElementById('posterUrlTab');
            const uploadTab = document.getElementById('posterUploadTab');
            const buttons = document.querySelectorAll('.poster-upload-section .tab-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'url') {
                urlTab.classList.add('active');
                uploadTab.classList.remove('active');
                buttons[0].classList.add('active');
            } else {
                urlTab.classList.remove('active');
                uploadTab.classList.add('active');
                buttons[1].classList.add('active');
            }
        }

        // Upload handlers
        async function handleTrailerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const progressDiv = document.getElementById('trailerUploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const resultDiv = document.getElementById('trailerUploadResult');
            
            try {
                // Show progress
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                resultDiv.innerHTML = '';

                // Simulate progress
                const progressInterval = setInterval(() => {
                    const currentWidth = parseInt(progressBar.style.width) || 0;
                    if (currentWidth < 90) {
                        progressBar.style.width = (currentWidth + 10) + '%';
                    }
                }, 200);

                // Upload to Cloudinary via controller
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/MovieManagement/Movies/UploadVideo', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (result.success) {
                    // Update trailer URL input
                    const trailerUrlInput = document.getElementById('editTrailerUrl');
                    trailerUrlInput.value = result.videoUrl;
                    
                    resultDiv.innerHTML = `<div class="upload-success">✅ Upload thành công!</div>`;
                    
                    // Switch back to URL tab
                    switchTrailerTab('url');
                } else {
                    resultDiv.innerHTML = `<div class="upload-error">❌ ${result.message}</div>`;
                }

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Error uploading video:', error);
                resultDiv.innerHTML = `<div class="upload-error">❌ Lỗi khi upload video</div>`;
                progressDiv.style.display = 'none';
            }
        }

        async function handlePosterUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const progressDiv = document.getElementById('posterUploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const posterPreview = document.getElementById('posterPreview');
            
            try {
                // Show progress
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';

                // Simulate progress
                const progressInterval = setInterval(() => {
                    const currentWidth = parseInt(progressBar.style.width) || 0;
                    if (currentWidth < 90) {
                        progressBar.style.width = (currentWidth + 10) + '%';
                    }
                }, 200);

                // Upload to Cloudinary via controller
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/MovieManagement/Movies/UploadImage', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (result.success) {
                    // Update image URL input and preview
                    const imageUrlInput = document.getElementById('editImageUrl');
                    imageUrlInput.value = result.imageUrl;
                    posterPreview.src = result.imageUrl;
                    
                    showNotification('Upload poster thành công!', 'success');
                    
                    // Switch back to URL tab
                    switchPosterTab('url');
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Error uploading image:', error);
                showNotification('Lỗi khi upload hình ảnh', 'error');
                progressDiv.style.display = 'none';
            }
        }

        async function handleAdditionalImagesUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const progressDiv = document.getElementById('additionalUploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const container = document.getElementById('additionalImagesContainer');
            
            try {
                // Show progress
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';

                const uploadedImages = [];
                const totalFiles = files.length;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Update progress
                    const progress = ((i + 1) / totalFiles) * 100;
                    progressBar.style.width = progress + '%';

                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        const response = await fetch('/MovieManagement/Movies/UploadImage', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            uploadedImages.push({
                                url: result.imageUrl,
                                name: file.name
                            });
                        }
                    } catch (error) {
                        console.error(`Error uploading ${file.name}:`, error);
                    }
                }

                // Display uploaded images
                displayAdditionalImages(uploadedImages, container);
                
                showNotification(`Đã upload ${uploadedImages.length}/${totalFiles} hình ảnh thành công!`, 'success');

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Error uploading images:', error);
                showNotification('Lỗi khi upload hình ảnh', 'error');
                progressDiv.style.display = 'none';
            }
        }

        function displayAdditionalImages(images, container) {
            images.forEach((image, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'additional-image-item';
                imageDiv.innerHTML = `
                    <img src="${image.url}" alt="${image.name}" class="additional-image-preview">
                    <div class="image-overlay">
                        <span class="image-name">${image.name}</span>
                        <button type="button" class="btn-remove-image" onclick="removeAdditionalImage(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="image-meta">
                        <input type="text" class="additional-image-description" placeholder="Mô tả hình ảnh..." value="${image.description || ''}">
                    </div>
                `;
                container.appendChild(imageDiv);
            });
        }

        function removeAdditionalImage(button) {
            const imageItem = button.closest('.additional-image-item');
            imageItem.remove();
        }

        // Load genres and rooms for selection
        async function loadGenresAndRooms(movieData) {
            try {
                // Load genres
                const genresResponse = await fetch('/MovieManagement/Movies/GetGenres');
                const genresResult = await genresResponse.json();
                
                if (genresResult.success && genresResult.data && genresResult.data.data) {
                    populateGenres(genresResult.data.data, movieData);
                }
                
                // Load rooms  
                const roomsResponse = await fetch('/MovieManagement/Movies/GetCinemaRooms');
                const roomsResult = await roomsResponse.json();
                
                if (roomsResult.success && roomsResult.data && roomsResult.data.data) {
                    window.availableRooms = roomsResult.data.data;
                    loadExistingShowTimes(movieData);
                }
            } catch (error) {
                console.error('Error loading genres and rooms:', error);
            }
        }

        function populateGenres(genres, movieData) {
            const container = document.getElementById('genreCheckboxes');
            container.innerHTML = '';
            
            // Get existing genre IDs from movie data
            const existingGenreIds = [];
            if (movieData.genres || movieData.Genres) {
                const movieGenres = movieData.genres || movieData.Genres;
                if (Array.isArray(movieGenres)) {
                    movieGenres.forEach(genre => {
                        if (genre.id) existingGenreIds.push(genre.id);
                        else if (genre.Id) existingGenreIds.push(genre.Id);
                    });
                }
            }

            genres.forEach(genre => {
                const genreId = genre.id || genre.Id;
                const genreName = genre.name || genre.Name || genre.genreName || genre.GenreName;
                const isChecked = existingGenreIds.includes(genreId);
                
                const genreDiv = document.createElement('div');
                genreDiv.className = 'genre-checkbox-item';
                genreDiv.innerHTML = `
                    <label class="genre-checkbox-label">
                        <input type="checkbox" value="${genreId}" ${isChecked ? 'checked' : ''}>
                        <span class="genre-checkmark"></span>
                        ${genreName}
                    </label>
                `;
                container.appendChild(genreDiv);
            });
        }

        function loadExistingShowTimes(movieData) {
            const container = document.getElementById('showTimesContainer');
            container.innerHTML = '';
            
            // Load existing show times
            if (movieData.showTimes || movieData.ShowTimes) {
                const showTimes = movieData.showTimes || movieData.ShowTimes;
                if (Array.isArray(showTimes)) {
                    showTimes.forEach(showTime => {
                        let showDate = showTime.showDate || showTime.ShowDate;
                        const roomId = showTime.roomId || showTime.RoomId;
                        
                        // Convert to datetime-local format
                        if (showDate) {
                            const date = new Date(showDate);
                            showDate = date.toISOString().slice(0, 16); // Format for datetime-local input
                        }
                        
                        addShowTimeEntry(showDate, roomId);
                    });
                }
            }
            
            // Add one empty entry if no existing times
            if (container.children.length === 0) {
                addShowTimeEntry();
            }
        }

        function addShowTimeEntry(showDate = '', roomId = '') {
            const container = document.getElementById('showTimesContainer');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'showtime-entry';
            
            // Build room options
            let roomOptions = '<option value="">Chọn phòng chiếu</option>';
            if (window.availableRooms) {
                window.availableRooms.forEach(room => {
                    const id = room.id || room.Id;
                    const name = room.name || room.Name || room.roomName || room.RoomName;
                    const isSelected = id === roomId ? 'selected' : '';
                    roomOptions += `<option value="${id}" ${isSelected}>${name}</option>`;
                });
            }
            
            entryDiv.innerHTML = `
                <div class="showtime-fields">
                    <div class="showtime-field">
                        <label>Ngày chiếu</label>
                        <input type="datetime-local" class="showtime-date" value="${showDate}" required>
                    </div>
                    <div class="showtime-field">
                        <label>Phòng chiếu</label>
                        <select class="showtime-room" required>
                            ${roomOptions}
                        </select>
                    </div>
                    <div class="showtime-actions">
                        <button type="button" class="btn-remove-showtime" onclick="removeShowTimeEntry(this)">
                            🗑️
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(entryDiv);
        }

        function removeShowTimeEntry(button) {
            const entry = button.closest('.showtime-entry');
            entry.remove();
            
            // Ensure at least one entry remains
            const container = document.getElementById('showTimesContainer');
            if (container.children.length === 0) {
                addShowTimeEntry();
            }
        }

        async function updateMovie(event, movieId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            // Get version value (API expects enum string)
            const versionValue = formData.get('version'); // Already "TwoD", "ThreeD", "FourDX"
            
            // Collect all images with proper MovieImageDto format
            const images = [];
            
            // Add main poster as primary image
            const posterUrl = formData.get('imageUrl');
            const posterDescription = document.getElementById('posterDescription').value;
            if (posterUrl) {
                images.push({
                    imageUrl: posterUrl,
                    description: posterDescription || "Poster chính",
                    displayOrder: 1,
                    isPrimary: true
                });
            }
            
            // Add additional images
            const additionalImageItems = document.querySelectorAll('.additional-image-item');
            additionalImageItems.forEach((item, index) => {
                const img = item.querySelector('img');
                const descInput = item.querySelector('.additional-image-description');
                if (img && img.src && !img.src.includes('placeholder')) {
                    images.push({
                        imageUrl: img.src,
                        description: descInput ? descInput.value : `Hình ảnh ${index + 2}`,
                        displayOrder: index + 2,
                        isPrimary: false
                    });
                }
            });

            // Collect selected genres
            const genreIds = [];
            const checkedGenres = document.querySelectorAll('#genreCheckboxes input[type="checkbox"]:checked');
            checkedGenres.forEach(checkbox => {
                genreIds.push(checkbox.value);
            });

            // Collect show times
            const showTimes = [];
            const showTimeEntries = document.querySelectorAll('.showtime-entry');
            showTimeEntries.forEach(entry => {
                const dateInput = entry.querySelector('.showtime-date');
                const roomSelect = entry.querySelector('.showtime-room');
                if (dateInput && roomSelect && dateInput.value && roomSelect.value) {
                    // Convert datetime-local to ISO string
                    const showDateTime = new Date(dateInput.value).toISOString();
                    showTimes.push({
                        showDate: showDateTime,
                        roomId: roomSelect.value
                    });
                }
            });
            
            // genreIds and showTimes are now collected from UI inputs above
            // No need to preserve from original data since user can modify them
            
            // Build movie data according to MovieUpdateDto format
            const movieData = {
                id: movieId,
                title: formData.get('title'),
                releaseDate: formData.get('releaseDate'),
                endDate: formData.get('endDate'),
                director: formData.get('director'),
                actors: formData.get('actors'),
                productionCompany: formData.get('productionCompany'),
                runningTime: parseInt(formData.get('runningTime')),
                version: versionValue,
                rating: parseFloat(formData.get('rating')) || 0,
                trailerUrl: formData.get('trailerUrl'),
                content: formData.get('content'),
                isFeatured: formData.get('isFeatured') === 'on',
                isRecommended: formData.get('isRecommended') === 'on',
                // Required fields for MovieUpdateDto
                genreIds: genreIds,
                showTimes: showTimes,
                images: images
            };

            // Validate required fields
            if (genreIds.length === 0) {
                showNotification('Vui lòng chọn ít nhất một thể loại phim', 'error');
                return;
            }

            if (showTimes.length === 0) {
                showNotification('Vui lòng thêm ít nhất một lịch chiếu', 'error');
                return;
            }

            console.log('Sending movie data:', movieData); // Debug log

            try {
                const response = await fetch('/MovieManagement/Movies/UpdateMovieData', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(movieData)
                });

                const result = await response.json();
                if (result.success) {
                    showNotification(result.message, 'success');
                    closeModal('editMovieModal');
                    // Reload movies to show updated data
                    loadMovies();
            } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                    console.error('Update error:', result);
                }
            } catch (error) {
                console.error('Error updating movie:', error);
                showNotification('Đã xảy ra lỗi khi cập nhật phim', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Navigation dropdown support (similar to Details.cshtml)
        document.addEventListener('DOMContentLoaded', function() {
            // Enable Bootstrap dropdown if present
            const dropdownElementList = document.querySelectorAll('.dropdown-toggle');
            const dropdownList = [...dropdownElementList].map(dropdownToggleEl => {
                if (typeof bootstrap !== 'undefined') {
                    return new bootstrap.Dropdown(dropdownToggleEl);
                }
                return null;
            });
        });
    </script>
</body>
</html>