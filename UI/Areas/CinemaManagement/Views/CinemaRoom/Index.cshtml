@model System.Text.Json.JsonElement
@using System.Text.Json
@{
    ViewData["Title"] = "Quản lý phòng chiếu";
    ViewBag.PageTitle = "Quản lý phòng chiếu";
    ViewBag.ParentTitle = "Dashboard";
    ViewBag.ParentUrl = Url.Action("AdminDashboard", "Dashboard");
    Layout = null;
    

    bool hasData = false;
    int dataCount = 0;
    

    if (Model.ValueKind == JsonValueKind.Array && Model.GetArrayLength() > 0)
    {
        hasData = true;
        dataCount = Model.GetArrayLength();
    }
    else if (Model.ValueKind == JsonValueKind.Object)
    {

        if (Model.TryGetProperty("data", out var dataArray) && dataArray.ValueKind == JsonValueKind.Array && dataArray.GetArrayLength() > 0)
        {
            hasData = true;
            dataCount = dataArray.GetArrayLength();
        }

        else if (Model.TryGetProperty("roomName", out _))
        {
            hasData = true;
            dataCount = 1;
        }
    }
    
    ViewBag.HasData = hasData;
    ViewBag.DataCount = dataCount;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    
    
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="~/css/new-dashboard.css" />
    
    <link rel="stylesheet" href="~/css/CinemaManagement/index.css" />
    
</head>
<body>
    
    <div class="new-dashboard-layout">
        
        @await Html.PartialAsync("~/Views/Shared/_DashboardSidebar.cshtml")

        
        <main class="new-dashboard-main">
            <div class="content-wrapper">
                
                <header class="page-header">
                    @await Html.PartialAsync("~/Views/Shared/_DashboardBreadcrumb.cshtml")
                    <h1 class="page-title">
                        <span class="page-title-icon"><i class="fas fa-building"></i></span>
                        Quản lý phòng chiếu
                    </h1>
                    <p class="page-subtitle">Quản lý thông tin các phòng chiếu trong hệ thống rạp</p>
                </header>

                
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span>@TempData["Success"]</span>
                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>@TempData["Error"]</span>
                        <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                
                <div class="card">
                    
                    <div class="controls-bar">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="search-input" 
                                   placeholder="Tìm kiếm phòng chiếu..." 
                                   id="cinemaSearch"
                                   value="@ViewBag.Search">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="openCreateModal()">
                            <i class="fas fa-plus"></i>
                            Thêm phòng chiếu
                        </button>
                    </div>

                    
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px">#</th>
                                    <th style="width: 100px">Tên phòng</th>
                                    <th style="width: 100px">Số ghế</th>
                                    <th style="width: 130px">Trạng thái</th>
                                    <th style="width: 110px">Ngày tạo</th>
                                    <th style="width: 120px; text-align: center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var baseIndex = ((ViewBag.CurrentPage ?? 1) - 1) * (ViewBag.PageSize ?? 10);
                                    

                                    JsonElement dataToIterate;
                                    
                                    if (Model.ValueKind == JsonValueKind.Array)
                                    {
                                        dataToIterate = Model;
                                    }
                                    else if (Model.ValueKind == JsonValueKind.Object)
                                    {

                                        if (Model.TryGetProperty("data", out var dataArray))
                                        {
                                            dataToIterate = dataArray;
                                        }
                                        else if (Model.TryGetProperty("Data", out var DataArray))
                                        {
                                            dataToIterate = DataArray;
                                        }
                                        else if (Model.TryGetProperty("items", out var itemsArray))
                                        {
                                            dataToIterate = itemsArray;
                                        }
                                        else
                                        {

                                            if (Model.TryGetProperty("roomName", out _))
                                            {

                                                var tempDoc = JsonDocument.Parse($"[{Model.GetRawText()}]");
                                                dataToIterate = tempDoc.RootElement;
                                            }
                                            else
                                            {

                                                dataToIterate = JsonDocument.Parse("[]").RootElement;
                                            }
                                        }
                                    }
                                    else
                                    {

                                        dataToIterate = JsonDocument.Parse("[]").RootElement;
                                    }
                                }
                                
                                @if (ViewBag.HasData)
                                {
                                    @if (dataToIterate.ValueKind == JsonValueKind.Array && dataToIterate.GetArrayLength() > 0)
                                    {
                                        @foreach (var item in dataToIterate.EnumerateArray().Select((room, i) => new { room, index = i + 1 + baseIndex }))
                                        {
                                            <tr>
                                                <td>@item.index</td>
                                                <td>
                                                    <strong>
                                                        @if (item.room.TryGetProperty("roomName", out var roomNameElement))
                                                        {
                                                            @roomNameElement.GetString()
                                                        }
                                                        else
                                                        {
                                                            <span style="color: var(--gray-400)">N/A</span>
                                                        }
                                                    </strong>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">
                                                                                                                    <i class="fas fa-chair" style="font-size: 0.6rem;"></i>
                                                        @if (item.room.TryGetProperty("totalSeats", out var totalSeatsElement))
                                                        {
                                                            @totalSeatsElement.GetInt32()
                                                        }
                                                        else
                                                        {
                                                            <span>0</span>
                                                        }
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (item.room.TryGetProperty("status", out var statusElement))
                                                    {
                                                        var status = statusElement.GetBoolean();
                                                        <span class="badge @(status ? "badge-success" : "badge-danger")">
                                                            <i class="fas fa-circle"></i>
                                                            @(status ? "Hoạt động" : "Ngừng hoạt động")
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-success">
                                                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                                            Hoạt động
                                                        </span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (item.room.TryGetProperty("createdDate", out var createdDateElement))
                                                    {
                                                        if (DateTime.TryParse(createdDateElement.GetString(), out var createdDate))
                                                        {
                                                            @createdDate.ToString("dd/MM/yyyy")
                                                        }
                                                        else
                                                        {
                                                            <span style="color: var(--gray-400)">N/A</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span style="color: var(--gray-400)">N/A</span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="action-group">
                                                        @if (item.room.TryGetProperty("id", out var idElement))
                                                        {
                                                            var roomId = idElement.GetGuid();
                                                            <button onclick="openDetailsModal('@roomId')" 
                                                                    class="btn-icon btn-view" 
                                                                    title="Xem chi tiết">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button onclick="openEditModal('@roomId')" 
                                                               class="btn-icon btn-edit" 
                                                               title="Chỉnh sửa">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="confirmDelete('@roomId', '@(item.room.TryGetProperty("roomName", out var nameEl) ? nameEl.GetString() : "phòng này")')" 
                                                                    class="btn-icon btn-delete" 
                                                                    title="Xóa">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="6">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                    </div>
                                                    <h3>Dữ liệu không hợp lệ</h3>
                                                    <p>Không thể hiển thị dữ liệu phòng chiếu</p>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fas fa-building"></i>
                                                </div>
                                                <h3>Chưa có phòng chiếu</h3>
                                                <p>Bấm nút "Thêm phòng chiếu" để tạo phòng chiếu mới</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    

                    @{
                        var totalPages = ViewBag.Total != null && ViewBag.PageSize != null ? (int)Math.Ceiling((double)(int)ViewBag.Total / (int)ViewBag.PageSize) : 0;
                        var currentPage = ViewBag.CurrentPage ?? 1;
                        var currentPageSize = ViewBag.PageSize ?? 10;
                    }
                    @if (ViewBag.Total != null && ViewBag.PageSize != null && (int)ViewBag.Total > (int)ViewBag.PageSize)
                    {
                        <div class="pagination-wrapper">
                            <div class="pagination-info">
                                Hiển thị @((currentPage - 1) * currentPageSize + 1) - @Math.Min(currentPage * currentPageSize, (int)ViewBag.Total) 
                                trong tổng số @ViewBag.Total phòng chiếu
                            </div>
                            <div class="pagination-controls">
                                <a href="@Url.Action("Index", new { page = currentPage - 1, pageSize = currentPageSize, search = ViewBag.Search })" 
                                   class="page-btn @(currentPage <= 1 ? "disabled" : "")"
                                   @(currentPage <= 1 ? "onclick=\"return false;\"" : "")>
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                
                                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                {
                                    <a href="@Url.Action("Index", new { page = i, pageSize = currentPageSize, search = ViewBag.Search })" 
                                       class="page-btn @(i == currentPage ? "active" : "")">
                                        @i
                                    </a>
                                }
                                
                                <a href="@Url.Action("Index", new { page = currentPage + 1, pageSize = currentPageSize, search = ViewBag.Search })" 
                                   class="page-btn @(currentPage >= totalPages ? "disabled" : "")"
                                   @(currentPage >= totalPages ? "onclick=\"return false;\"" : "")>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                                
                                <form method="get" onchange="this.submit()" style="display: inline-block; margin-left: 1rem;">
                                    <input type="hidden" name="search" value="@ViewBag.Search" />
                                    <select name="pageSize" class="page-btn" style="width: auto; padding: 0 1rem;">
                                        <option value="5" selected="@(currentPageSize == 5 ? "selected" : null)">5/trang</option>
                                        <option value="10" selected="@(currentPageSize == 10 ? "selected" : null)">10/trang</option>
                                        <option value="20" selected="@(currentPageSize == 20 ? "selected" : null)">20/trang</option>
                                    </select>
                                </form>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </main>
    </div>

    
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                    Xác nhận xóa
                </h3>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">
                    Bạn có chắc chắn muốn xóa phòng chiếu <strong id="roomNameToDelete" style="color: var(--primary);"></strong>?
                </p>
                <div style="background: var(--danger-light); padding: 1rem; border-radius: var(--radius); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle" style="color: var(--danger);"></i>
                    <span style="color: var(--danger); font-size: 0.875rem;">
                        Hành động này không thể hoàn tác. Tất cả dữ liệu liên quan sẽ bị xóa vĩnh viễn.
                    </span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary">
                    Hủy bỏ
                </button>
                <form id="deleteForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-primary" style="background: var(--danger); box-shadow: none;">
                        <i class="fas fa-trash"></i>
                        Xóa phòng chiếu
                    </button>
                </form>
            </div>
        </div>
    </div>

    
    <div id="createModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle" style="color: var(--primary);"></i>
                    Thêm phòng chiếu mới
                </h3>
                <button class="modal-close" onclick="closeCreateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="createRoomForm" onsubmit="submitCreateForm(event)">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="roomName" class="form-label">
                                <i class="fas fa-tag me-1"></i>Tên phòng chiếu <span style="color: var(--danger);">*</span>
                            </label>
                            <input type="text" id="roomName" name="RoomName" class="form-control-modal" 
                                   placeholder="Nhập tên phòng chiếu (VD: Phòng A01)" required maxlength="50">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Tên phòng chiếu phải có độ dài từ 1-50 ký tự
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="numberOfRows" class="form-label">
                                <i class="fas fa-arrows-alt-v me-1"></i>Số hàng <span style="color: var(--danger);">*</span>
                            </label>
                            <input type="number" id="numberOfRows" name="NumberOfRows" class="form-control-modal" 
                                   placeholder="10" min="1" max="50" required oninput="calculateTotalSeats()">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Từ 1 đến 50 hàng
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="numberOfColumns" class="form-label">
                                <i class="fas fa-arrows-alt-h me-1"></i>Số cột <span style="color: var(--danger);">*</span>
                            </label>
                            <input type="number" id="numberOfColumns" name="NumberOfColumns" class="form-control-modal" 
                                   placeholder="12" min="1" max="50" required oninput="calculateTotalSeats()">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Từ 1 đến 50 cột
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="totalSeats" class="form-label">
                                <i class="fas fa-chair me-1"></i>Tổng số ghế
                            </label>
                            <input type="number" id="totalSeats" name="TotalSeats" class="form-control-modal" 
                                   placeholder="120" readonly style="background: var(--gray-100);">
                            <div class="form-text">
                                <i class="fas fa-calculator me-1"></i>
                                Tự động tính từ số hàng × số cột
                            </div>
                        </div>
                    </div>

                    
                    <div id="layoutPreview" class="mt-4" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-eye me-2"></i>Xem trước layout ghế</h6>
                        <div class="layout-preview-container">
                            <div class="screen-preview">
                                <i class="fas fa-desktop me-2"></i>MÀN HÌNH CHIẾU
                            </div>
                            <div id="seatPreviewGrid" class="seat-preview-grid"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-2"></i>Tạo phòng chiếu
                    </button>
                </div>
            </form>
        </div>
    </div>

    
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content-wide">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-info-circle"></i>
                    Chi tiết phòng chiếu
                </h3>
                <button class="modal-close" onclick="closeDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detailsModalBody">
                <div class="loading-spinner" id="detailsLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Đang tải thông tin...</span>
                </div>
                <div id="detailsContent" style="display: none;">
                    
                </div>
            </div>
        </div>
    </div>

    
    <div id="editModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit" style="color: var(--warning);"></i>
                    Chỉnh sửa phòng chiếu
                </h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="editModalBody">
                <div class="loading-spinner" id="editLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Đang tải thông tin...</span>
                </div>
                <div id="editContent" style="display: none;">
                    
                </div>
            </div>
        </div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    
    <script src="~/js/CinemaManagement/index.js"></script>

    
</body>
</html