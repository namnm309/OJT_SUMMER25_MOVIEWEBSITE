@model UI.Areas.ShowtimeManagement.Models.EditShowtimeViewModel

<form id="showtimeForm" asp-action="Edit" asp-controller="Showtimes" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="MovieId" class="form-label">Phim <span class="text-danger">*</span></label>
                <select asp-for="MovieId" class="form-select" required>
                    <option value="">-- Chọn phim --</option>
                    @foreach (var movie in Model.Movies)
                    {
                        <option value="@movie.Id" data-duration="@movie.RunningTime">
                            @movie.Title (@movie.RunningTime phút)
                        </option>
                    }
                </select>
                <span asp-validation-for="MovieId" class="text-danger"></span>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="CinemaRoomId" class="form-label">Phòng chiếu <span class="text-danger">*</span></label>
                <select asp-for="CinemaRoomId" class="form-select" required>
                    <option value="">-- Chọn phòng --</option>
                    @foreach (var room in Model.CinemaRooms)
                    {
                        <option value="@room.Id">
                            @room.Name - @room.RoomType (@room.TotalSeats ghế)
                        </option>
                    }
                </select>
                <span asp-validation-for="CinemaRoomId" class="text-danger"></span>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="ShowDate" class="form-label">Ngày chiếu <span class="text-danger">*</span></label>
                <input asp-for="ShowDate" type="date" class="form-control" required />
                <span asp-validation-for="ShowDate" class="text-danger"></span>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="StartTime" class="form-label">Giờ bắt đầu <span class="text-danger">*</span></label>
                <input asp-for="StartTime" type="time" class="form-control" required />
                <span asp-validation-for="StartTime" class="text-danger"></span>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="Price" class="form-label">Giá vé (VNĐ) <span class="text-danger">*</span></label>
                <input asp-for="Price" type="number" class="form-control" min="0" step="1000" required />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">Thời gian kết thúc (dự kiến)</label>
                <input type="text" class="form-control" id="endTimePreview" readonly />
                <small class="text-muted">Tự động tính dựa trên thời lượng phim + 15 phút dọn dẹp</small>
            </div>
        </div>
    </div>
    
    <div class="alert alert-warning d-none" id="conflictWarning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="conflictMessage"></span>
    </div>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Lưu ý:</strong> Chỉ có thể chỉnh sửa lịch chiếu chưa diễn ra và chưa có vé nào được đặt.
    </div>
    
    <div class="modal-footer px-0 pb-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveShowtime()">
            <i class="fas fa-save me-2"></i>
            Cập nhật lịch chiếu
        </button>
    </div>
</form>

<script>
    $(document).ready(function() {

        function updateEndTimePreview() {
            const movieSelect = $('#MovieId');
            const startTimeInput = $('#StartTime');
            const selectedOption = movieSelect.find('option:selected');
            const duration = parseInt(selectedOption.data('duration') || 0);
            const startTime = startTimeInput.val();
            
            if (duration && startTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startMinutes = hours * 60 + minutes;
                const endMinutes = startMinutes + duration + 15; // Add 15 minutes for cleaning
                
                const endHours = Math.floor(endMinutes / 60);
                const endMins = endMinutes % 60;
                
                $('#endTimePreview').val(`${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`);
                

                checkScheduleConflict();
            }
        }
        
        $('#MovieId, #StartTime').change(updateEndTimePreview);
        $('#ShowDate, #CinemaRoomId').change(checkScheduleConflict);
        

        function checkScheduleConflict() {
            const movieId = $('#MovieId').val();
            const roomId = $('#CinemaRoomId').val();
            const showDate = $('#ShowDate').val();
            const startTime = $('#StartTime').val();
            const selectedOption = $('#MovieId').find('option:selected');
            const duration = parseInt(selectedOption.data('duration') || 0);
            const showtimeId = $('#Id').val();
            
            if (roomId && showDate && startTime && duration) {
                $.get('@Url.Action("CheckConflict", "Showtimes")', {
                    cinemaRoomId: roomId,
                    showDate: showDate,
                    startTime: startTime,
                    duration: duration,
                    excludeId: showtimeId
                }, function(response) {
                    if (response.hasConflict) {
                        $('#conflictWarning').removeClass('d-none');
                        $('#conflictMessage').text('Lịch chiếu bị trùng với suất chiếu khác trong phòng này!');
                    } else {
                        $('#conflictWarning').addClass('d-none');
                    }
                });
            }
        }
        

        const today = new Date().toISOString().split('T')[0];
        $('#ShowDate').attr('min', today);
        

        updateEndTimePreview();
    });
</script> 