@using System.Security.Claims
@using System.Text.Json
@model UI.Models.HomeViewModel
@{
    ViewData["Title"] = "Trang Chủ - Cinema City";
}

@section Styles {
    <link rel="stylesheet" href="~/css/HomePage/base.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/header.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/hero.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/button.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/responsive.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/banner.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/movie-poster-overlay.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/HomePage/moviecard.css" asp-append-version="true" />
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<div class="cinema-homepage">
    <!-- Hero Section -->
    <div class="hero-section" id="heroSection">
        <!-- Navigation -->
        <div class="hero-nav">
            <div class="nav-content">
                <div class="nav-left">
                    <div class="brand">
                        <div class="brand-content">
                            <div class="brand-header">
                                <span class="brand-name">Cinema City</span>
                                <div class="brand-logo"></div>
                            </div>
                            <div class="brand-subtitle">Rạp chiếu phim hiện đại</div>
                        </div>
                    </div>
                    <div class="search-box">
                        <input type="text" placeholder="Tìm kiếm phim..." class="search-input" id="movieSearchInput">
                        <i class="fas fa-search search-icon" id="searchButton"></i>
                    </div>
                </div>
                <div class="nav-center">
                    <div class="nav-links">
                        <a href="#" class="nav-link">Giới thiệu</a>
                        <a href="@Url.Action("Index", "Events")" class="nav-link">
                            <span>Sự kiện</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <a href="@Url.Action("Index", "Products")" class="nav-link">
                            <span>Sản phẩm</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <a href="@Url.Action("Index", "Movies")" class="nav-link">
                            <span>Phim</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="divider"></div>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="user-profile">
                            <div class="dropdown">
                                <button class="btn-profile dropdown-toggle" type="button" id="userDropdown">
                                    <i class="fas fa-user-circle"></i>
                                    @if (ViewContext.HttpContext.User.Identity?.Name?.Length > 10)
                                    {
                                        <span class="d-none d-md-inline">@ViewContext.HttpContext.User.Identity.Name.Substring(0, 10)...</span>
                                    }
                                    else
                                    {
                                        <span class="d-none d-md-inline">@ViewContext.HttpContext.User.Identity?.Name</span>
                                    }
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                    <li class="dropdown-header">
                                        <div class="user-info">
                                            <i class="fas fa-user-circle fa-2x mb-2"></i>
                                            <div class="user-name">@ViewContext.HttpContext.User.Identity?.Name</div>
                                            <div class="user-email">@ViewContext.HttpContext.User.FindFirst(ClaimTypes.Email)?.Value</div>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Profile", "Account", new { area = "UserManagement" })">
                                            <i class="fas fa-user-edit"></i>
                                            Chỉnh sửa thông tin
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Index", "Dashboard")">
                                            <i class="fas fa-tachometer-alt"></i>
                                            Dashboard
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-action="Logout" asp-controller="Account" method="post" class="m-0">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="fas fa-sign-out-alt"></i>
                                                Đăng xuất
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="auth-buttons">
                            <a href="@Url.Action("Register", "Account")" class="btn-register">Đăng ký</a>
                            <a href="@Url.Action("Login", "Account")" class="btn-login">Đăng nhập</a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Movie Content -->
        <div class="movie-content" id="movieContent">
            @if (Model?.FeaturedMovie != null)
            {
                <div class="movie-info">
                    <div class="movie-header">
                        <h1 class="movie-title" id="movieTitle">@Model.FeaturedMovie.Title</h1>
                        <p class="movie-title-vn" id="movieTitleVn">@(Model.FeaturedMovie.Director ?? "Đạo diễn")</p>
                    </div>
                    
                    <div class="movie-details">
                        <div class="plot-section">
                            <h3>Tóm tắt nội dung</h3>
                            <p id="moviePlot">
                                @(Model.FeaturedMovie.Content ?? "Chưa có thông tin nội dung.")
                            </p>
                        </div>

                        <div class="genre-section">
                            <h3>Thể loại</h3>
                            <p id="movieGenre">@(Model.FeaturedMovie.Genres != null && Model.FeaturedMovie.Genres.Any() ? string.Join(", ", Model.FeaturedMovie.Genres) : "Chưa phân loại")</p>
                        </div>

                        <div class="ratings-section">
                            <div class="rating-item">
                                <i class="fas fa-clock"></i>
                                <span id="duration">@Model.FeaturedMovie.RunningTime phút</span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-primary" onclick="bookTickets()">
                                <i class="fas fa-ticket-alt"></i>
                                Đặt vé ngay
                            </button>
                            <button class="btn-secondary" onclick="showMovieInfo()">
                                <i class="fas fa-info-circle"></i>
                                Thông tin phim
                            </button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="movie-info">
                    <div class="loading-container">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin fa-3x"></i>
                        </div>
                        <h2 class="loading-text">Đang tải dữ liệu phim...</h2>
                        <p class="loading-subtext">Vui lòng đợi trong giây lát</p>
                    </div>
                </div>
            }

            <div class="movie-controls">
                <div class="control-left">
                    <button class="nav-btn" onclick="previousMovie()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                
                <div class="pagination-dots" id="paginationDots">
                    @if (Model?.HeroMovies != null && Model.HeroMovies.Any())
                    {
                        for (int i = 0; i < Model.HeroMovies.Count; i++)
                        {
                            <span class="dot @(i == 0 ? "active" : "")"></span>
                        }
                    }
                    else
                    {
                        <span class="dot active"></span>
                    }
                </div>

                <div class="control-right">
                    <button class="nav-btn" onclick="nextMovie()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Search Section -->
    <div class="search-section">
        <div class="search-header" onclick="toggleSearch()">
            <i class="fas fa-chevron-up search-toggle"></i>
            <h2>Tìm kiếm nâng cao phim và TV series</h2>
        </div>
        
        <div class="search-form" id="searchForm">
            <div class="form-grid">
                <div class="form-column">
                    <div class="form-group">
                        <label>Năm phát hành đến</label>
                        <select class="form-select">
                            <option>Chưa chọn</option>
                            <option>2024</option>
                            <option>2023</option>
                            <option>2022</option>
                        </select>
                    </div>                  
                </div>

                <div class="form-column">
                    <div class="form-group">
                        <label>Năm phát hành từ</label>
                        <select class="form-select">
                            <option>Chưa chọn</option>
                            <option>1990</option>
                            <option>2000</option>
                            <option>2010</option>
                        </select>
                    </div>

                </div>

                <div class="form-column">
                    <div class="form-group">
                        <label>Thể loại</label>
                        <select class="form-select">
                            <option>Tất cả</option>
                            <option>Hành động</option>
                            <option>Tình cảm</option>
                            <option>Kinh dị</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chất lượng</label>
                        <select class="form-select">
                            <option>Tất cả</option>
                            <option>4K</option>
                            <option>HD</option>
                            <option>Full HD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Độ tuổi</label>
                        <select class="form-select">
                            <option>Tất cả</option>
                            <option>P</option>
                            <option>T13</option>
                            <option>T16</option>
                            <option>T18</option>
                        </select>
                    </div>
                </div>

                <div class="form-column">
                    <div class="form-group">
                        <label>Loại</label>
                        <select class="form-select">
                            <option>Tất cả</option>
                            <option>Phim lẻ</option>
                            <option>Phim bộ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quốc gia</label>
                        <select class="form-select">
                            <option>Tất cả</option>
                            <option>Việt Nam</option>
                            <option>Mỹ</option>
                            <option>Hàn Quốc</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Diễn viên</label>
                        <input type="text" class="form-input" placeholder="Nhập tên diễn viên">
                    </div>
                    <div class="form-group">
                        <label>Đạo diễn</label>
                        <input type="text" class="form-input" placeholder="Nhập tên đạo diễn">
                    </div>
                </div>
            </div>

            <div class="form-bottom">
                <button class="btn-search">Áp dụng bộ lọc và tìm kiếm</button>
                
                <div class="sort-section">
                    <label>Sắp xếp</label>
                    <select class="form-select">
                        <option>Theo năm phát hành</option>
                        <option>Theo tên phim</option>
                    </select>
                </div>

                <div class="toggle-section">
                    <div class="toggle-item">
                        <span>Phụ đề</span>
                        <div class="toggle-switch active">
                            <div class="toggle-circle"></div>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <span>Lồng tiếng</span>
                        <div class="toggle-switch">
                            <div class="toggle-circle"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Movies Section -->
    <div class="recommended-section">
        <div class="section-header">
            <div class="nav-controls">
                <button class="nav-btn" onclick="slideMovies('left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-btn" onclick="slideMovies('right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <h2>Phim đề xuất</h2>
        </div>

        <div class="movies-grid" id="moviesGrid">
            @if (Model?.RecommendedMovies != null && Model.RecommendedMovies.Any())
            {
                foreach (var movie in Model.RecommendedMovies)
                {
                    <div class="movie-card">
                        <div class="movie-poster">
                            @if (!string.IsNullOrEmpty(movie.PrimaryImageUrl))
                            {
                                <img src="@movie.PrimaryImageUrl" alt="@movie.Title" loading="lazy">
                            }
                            else if (!string.IsNullOrEmpty(movie.ImageUrl))
                            {
                                <img src="@movie.ImageUrl" alt="@movie.Title" loading="lazy">
                            }
                            else if (movie.Images != null && movie.Images.Any())
                            {
                                var primaryImage = movie.Images.FirstOrDefault(img => img.IsPrimary) ?? movie.Images.First();
                                <img src="@primaryImage.ImageUrl" alt="@movie.Title" loading="lazy">
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Image" alt="@movie.Title" loading="lazy">
                            }
                            <div class="movie-poster-overlay">
                                <div class="overlay-content">
                                    <h3>Tóm tắt nội dung</h3>
                                    <p>@(string.IsNullOrEmpty(movie.Content) ? "Chưa có thông tin nội dung." : (movie.Content.Length > 150 ? movie.Content.Substring(0, 150) + "..." : movie.Content))</p>
                                    <div class="overlay-details">
                                        <div class="detail-col">
                                            <span class="detail-label">Thể loại</span>
                                            <span class="detail-value">@(movie.Genres != null && movie.Genres.Any() ? string.Join(", ", movie.Genres) : "Chưa phân loại")</span>
                                        </div>
                                        <div class="detail-col">
                                            <span class="detail-label">Phiên bản</span>
                                            <span class="detail-value">@movie.Version</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="movie-meta">
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span>@movie.RunningTime phút</span>
                            </div>
                        </div>
                        <h3 class="movie-name">@movie.Title</h3>
                    </div>
                }
            }
            else
            {
                <div class="loading-grid">
                    <div class="loading-card">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                        </div>
                        <p class="loading-text">Đang tải danh sách phim...</p>
                    </div>
                </div>
            }
        </div>

        <button class="view-all-btn" onclick="location.href='@Url.Action("Index", "Movies")'">
            <i class="fas fa-chevron-left"></i>
            <span>Xem tất cả</span>
        </button>
    </div>

    <!-- Featured Banner Section -->
    <div class="container">
        @if (Model?.FeaturedMovie != null)
        {
            <div class="featured-banner" @(Model.FeaturedMovie.PrimaryImageUrl != null ? $"style=\"background-image: url('{Model.FeaturedMovie.PrimaryImageUrl}');\"" : Model.FeaturedMovie.Images != null && Model.FeaturedMovie.Images.Any() ? $"style=\"background-image: url('{Model.FeaturedMovie.Images.FirstOrDefault(img => img.IsPrimary)?.ImageUrl ?? Model.FeaturedMovie.Images.First().ImageUrl}');\"" : "")>
                <div class="banner-content">
                    <div class="banner-info">
                        <div class="banner-header">
                            <h2 class="banner-title">@Model.FeaturedMovie.Title</h2>
                            <p class="banner-title-vn">@(Model.FeaturedMovie.ProductionCompany ?? "Nhà sản xuất")</p>
                        </div>
                        
                        <div class="banner-plot">
                            <h3>Tóm tắt nội dung</h3>
                            <p>@(string.IsNullOrEmpty(Model.FeaturedMovie.Content) ? "Chưa có thông tin nội dung." : Model.FeaturedMovie.Content)</p>
                        </div>

                        <div class="banner-genre">
                            <h3>Thể loại</h3>
                            <p>@(Model.FeaturedMovie.Genres != null && Model.FeaturedMovie.Genres.Any() ? string.Join(", ", Model.FeaturedMovie.Genres) : "Chưa phân loại")</p>
                        </div>

                        <div class="banner-ratings">
                            <div class="rating-item">
                                <i class="fas fa-clock"></i>
                                <span>@Model.FeaturedMovie.RunningTime phút</span>
                            </div>
                        </div>

                        <a href="@Url.Action("Details", "Movies", new { id = Model.FeaturedMovie.Id })" class="btn-banner">
                            Xem chi tiết phim
                        </a>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="featured-banner">
                <div class="banner-content">
                    <div class="loading-container">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin fa-3x"></i>
                        </div>
                        <h2 class="loading-text">Đang tải thông tin phim nổi bật...</h2>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Truyền dữ liệu phim từ server sang JavaScript
        window.heroMovies = @Html.Raw(Json.Serialize(Model?.HeroMovies?.Select(m => new {
            id = m.Id,
            title = m.Title,
            titleVn = m.ProductionCompany ?? "Nhà sản xuất",
            plot = m.Content ?? "Chưa có thông tin nội dung.",
            genre = m.Genres != null && m.Genres.Any() ? string.Join(", ", m.Genres) : "Chưa phân loại",
            duration = m.RunningTime > 0 ? $"{m.RunningTime} phút" : "Chưa có thông tin",
            background = m.PrimaryImageUrl ?? (m.Images != null && m.Images.Any() ? m.Images.FirstOrDefault(img => img.IsPrimary)?.ImageUrl ?? m.Images.First().ImageUrl : "https://via.placeholder.com/1920x1080/1a1a1a/ffffff?text=No+Image")
        }) ?? new[] { new {
            id = "",
            title = "Oppenheimer 2023",
            titleVn = "Cha đẻ bom nguyên tử",
            plot = "Phim Oppenheimer kể về cuộc đời của J. Robert Oppenheimer, nhà vật lý lý thuyết người Mỹ được mệnh danh là 'cha đẻ của bom nguyên tử' vì vai trò của ông trong Dự án Manhattan.",
            genre = "Lịch sử, Tiểu sử, Chính kịch",
            duration = "3 Giờ",
            background = "https://image.tmdb.org/t/p/original/8Gxv8gSFCU0XGDykEGv7zR1n2ua.jpg"
        }}));
        
        window.movieUrls = {
            moviesIndex: '@Url.Action("Index", "Movies")',
            movieDetails: '@Url.Action("Details", "Movies")'
        };

        // Search functionality
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('movieSearchInput');
            const searchButton = document.getElementById('searchButton');

            // Search on button click
            searchButton?.addEventListener('click', function () {
                performSearch();
            });

            // Search on Enter key press
            searchInput?.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            async function performSearch() {
                const keyword = searchInput.value.trim();
                console.log('Search keyword:', keyword); // Thêm dòng này

                // Redirect to search results page
                const searchUrl = '@Url.Action("Search", "Movies")' + (keyword ? `?keyword=${encodeURIComponent(keyword)}` : '');
                console.log('Search URL:', searchUrl); // Thêm dòng này
                window.location.href = searchUrl;
            }
        });
    </script>
    <script src="~/js/homepage.js"></script>
}