@{
    ViewData["Title"] = "Quản lý thành viên";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Cinema City</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="~/css/dashboard.css" />
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="brand-section">
                <a href="@Url.Action("Index", "Home")" class="d-flex align-items-center text-decoration-none">
                    <div class="brand-logo"></div>
                    <div class="ms-3">
                        <div class="brand-name">Cinema City</div>
                        <div class="brand-subtitle">Rạp chiếu phim hiện đại</div>
                    </div>
                </a>
            </div>
            <nav class="nav-links">
                <a href="@Url.Action("Index", "Home")" class="nav-link">Trang chủ</a>
                <a href="@Url.Action("Index", "Movies")" class="nav-link">Phim</a>
                <a href="@Url.Action("Index", "Events")" class="nav-link">Sự kiện</a>
                <a href="@Url.Action("Index", "Dashboard")" class="nav-link active">Dashboard</a>
                
                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-avatar">
                            @User.Identity?.Name?.Substring(0, 1).ToUpper()
                        </div>
                        <span class="user-name">@User.Identity?.Name</span>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-users"></i>
                Quản lý thành viên
            </h1>
            <p class="page-subtitle">Danh sách và quản lý tất cả thành viên trong hệ thống</p>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <a href="/Dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                </a>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-search me-2"></i>Tìm kiếm và lọc
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="searchName" class="form-label">Tìm theo tên</label>
                                    <input type="text" class="form-control" id="searchName" placeholder="Nhập tên thành viên...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="filterRole" class="form-label">Vai trò</label>
                                    <select class="form-select" id="filterRole">
                                        <option value="">Tất cả vai trò</option>
                                        <option value="Member">Thành viên</option>
                                        <option value="Staff">Nhân viên</option>
                                        <option value="Admin">Quản trị viên</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="filterStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="">Tất cả trạng thái</option>
                                        <option value="true">Hoạt động</option>
                                        <option value="false">Không hoạt động</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="searchMembers()">
                                        <i class="fas fa-search me-1"></i>Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="dashboard-card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="card-title mb-0" id="totalMembers">-</h5>
                                <p class="card-text text-muted small mb-0">Tổng thành viên</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-success">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="card-title mb-0" id="activeMembers">-</h5>
                                <p class="card-text text-muted small mb-0">Đang hoạt động</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-warning">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="card-title mb-0" id="staffMembers">-</h5>
                                <p class="card-text text-muted small mb-0">Nhân viên</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-info">
                                <i class="fas fa-calendar-plus"></i>
                            </div>
                            <div class="ms-3">
                                <h5 class="card-title mb-0" id="newMembers">-</h5>
                                <p class="card-text text-muted small mb-0">Mới tuần này</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error display -->
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                @TempData["ErrorMessage"]
            </div>
        }

        <!-- Members Table -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>Danh sách thành viên
                            </h5>
                            @if(User.IsInRole("Admin"))
                            {
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                                    <i class="fas fa-plus me-1"></i>Thêm thành viên mới
                                </button>
                            }
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="membersTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Tên đăng nhập</th>
                                        <th>Họ tên</th>
                                        <th>Email</th>
                                        <th>Vai trò</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày tạo</th>
                                        @if(User.IsInRole("Admin"))
                                        {
                                            <th>Thao tác</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody id="membersTableBody">
                                    @if (ViewBag.Members != null && ViewBag.Members.Length > 0)
                                    {
                                        @foreach (var member in ViewBag.Members)
                                        {
                                            <tr>
                                                <td>@member.GetProperty("userId").ToString()</td>
                                                <td>
                                                    <strong>@member.GetProperty("username").ToString()</strong>
                                                </td>
                                                <td>@member.GetProperty("fullName").ToString()</td>
                                                <td>@member.GetProperty("email").ToString()</td>
                                                <td>
                                                    @{
                                                        var role = member.GetProperty("role").ToString();
                                                    }
                                                    @if(role == "Admin")
                                                    {
                                                        <span class="badge bg-danger">Quản trị viên</span>
                                                    }
                                                    else if(role == "Staff")
                                                    {
                                                        <span class="badge bg-warning">Nhân viên</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-info">Thành viên</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge bg-success">Hoạt động</span>
                                                </td>
                                                <td>
                                                    @{
                                                        var createdAt = member.GetProperty("createdAt").ToString();
                                                        if (DateTime.TryParse(createdAt, out DateTime created))
                                                        {
                                                            @created.ToString("dd/MM/yyyy")
                                                        }
                                                        else
                                                        {
                                                            @createdAt
                                                        }
                                                    }
                                                </td>
                                                @if(User.IsInRole("Admin"))
                                                {
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                                onclick="viewMember('@member.GetProperty("userId").ToString()')" title="Xem chi tiết">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-warning me-1" 
                                                                onclick="editMember('@member.GetProperty("userId").ToString()')" title="Chỉnh sửa">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                                onclick="toggleMemberStatus('@member.GetProperty("userId").ToString()', false)" title="Vô hiệu hóa">
                                                            <i class="fas fa-user-slash"></i>
                                                        </button>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Không có dữ liệu thành viên để hiển thị
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Phân trang" class="mt-3">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="cinema-footer">
        <div class="footer-container">
            <div class="footer-content">
                <p>&copy; @DateTime.Now.Year Cinema City. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    @section Scripts {
        <script>
            // Initialize page
            document.addEventListener('DOMContentLoaded', function() {
                updateStats();
                initializeTable();
            });

            // Search members
            function searchMembers() {
                const name = document.getElementById('searchName').value;
                const role = document.getElementById('filterRole').value;
                const status = document.getElementById('filterStatus').value;
                
                // TODO: Implement API call to search members
                console.log('Searching with:', { name, role, status });
            }

            // Update statistics
            function updateStats() {
                if (typeof ViewBag !== 'undefined' && ViewBag.Members) {
                    const members = @Html.Raw(Json.Serialize(ViewBag.Members ?? new object[0]));
                    
                    document.getElementById('totalMembers').textContent = members.length;
                    document.getElementById('activeMembers').textContent = members.filter(m => m.isActive).length;
                    document.getElementById('staffMembers').textContent = members.filter(m => m.role === 'Staff' || m.role === 'Admin').length;
                    
                    // New members this week (placeholder)
                    document.getElementById('newMembers').textContent = Math.floor(Math.random() * 10);
                } else {
                    document.getElementById('totalMembers').textContent = '0';
                    document.getElementById('activeMembers').textContent = '0';
                    document.getElementById('staffMembers').textContent = '0';
                    document.getElementById('newMembers').textContent = '0';
                }
            }

            // Initialize table features
            function initializeTable() {
                // TODO: Add sorting, pagination, etc.
            }

            // View member details
            function viewMember(id) {
                // TODO: Show member details modal
                alert('Xem chi tiết thành viên ID: ' + id);
            }

            // Edit member
            function editMember(id) {
                // TODO: Show edit member modal
                alert('Chỉnh sửa thành viên ID: ' + id);
            }

            // Toggle member status
            function toggleMemberStatus(id, newStatus) {
                if (confirm('Bạn có chắc chắn muốn thay đổi trạng thái của thành viên này?')) {
                    // TODO: API call to toggle status
                    alert('Đổi trạng thái thành viên ID: ' + id + ' thành ' + (newStatus ? 'hoạt động' : 'không hoạt động'));
                }
            }

            // Add new member (Admin only)
            function addMember() {
                const form = document.getElementById('addMemberForm');
                const formData = new FormData(form);
                
                // Basic validation
                const username = document.getElementById('newUsername').value;
                const email = document.getElementById('newEmail').value;
                const fullName = document.getElementById('newFullName').value;
                const password = document.getElementById('newPassword').value;
                const role = document.getElementById('newRole').value;
                
                if (!username || !email || !fullName || !password || !role) {
                    alert('Vui lòng điền đầy đủ thông tin!');
                    return;
                }
                
                // TODO: API call to add member
                alert('Thêm thành viên mới: ' + fullName);
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal'));
                modal.hide();
                form.reset();
            }

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    if (alert.classList.contains('alert-danger') || alert.classList.contains('alert-success')) {
                        alert.style.transition = 'opacity 0.5s';
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 500);
                    }
                });
            }, 5000);
        </script>
    }
</body>
</html>
