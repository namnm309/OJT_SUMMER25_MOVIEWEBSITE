@{
    Layout = null;
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Xác nhận thông tin</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Thông tin phim</h6>
                        <div id="movieDetails"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Thông tin suất chiếu</h6>
                        <div id="showtimeDetails"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h6>Ghế đã chọn</h6>
                        <div id="selectedSeatsDetails" class="mb-3"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h6>Phương thức thanh toán</h6>
                        <div class="payment-methods">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cashPayment" value="cash" checked>
                                <label class="form-check-label" for="cashPayment">
                                    <i class="fas fa-money-bill-wave me-2"></i>Tiền mặt
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="vnpayPayment" value="vnpay">
                                <label class="form-check-label" for="vnpayPayment">
                                    <i class="fas fa-credit-card me-2"></i>VNPay
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Tóm tắt đơn hàng</h5>
            </div>
            <div class="card-body">
                <div class="order-summary">
                    <div class="summary-item">
                        <span>Tổng số ghế:</span>
                        <span id="totalSeats">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Tổng tiền:</span>
                        <span id="totalAmount">0 VNĐ</span>
                    </div>
                    <div class="summary-item">
                        <span>Khuyến mãi:</span>
                        <span id="discount">0 VNĐ</span>
                    </div>
                    <div class="summary-item total">
                        <strong>Thành tiền:</strong>
                        <strong id="finalAmount">0 VNĐ</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12 d-flex justify-content-between">
        <button class="btn btn-secondary" onclick="prevStep(3)">
            <i class="fas fa-arrow-left me-2"></i>Quay lại
        </button>
        <button class="btn btn-success" id="confirmBooking">
            Xác nhận đặt vé <i class="fas fa-check ms-2"></i>
        </button>
    </div>
</div>

<script>
$(document).ready(function() {
    // Lấy thông tin từ localStorage
    const selectedMovie = JSON.parse(localStorage.getItem('selectedMovie'));
    const selectedShowtime = JSON.parse(localStorage.getItem('selectedShowtime'));
    const selectedSeats = JSON.parse(localStorage.getItem('selectedSeats'));

    // Hiển thị thông tin phim
    if (selectedMovie) {
        $('#movieDetails').html(`
            <p><strong>Tên phim:</strong> ${selectedMovie.title}</p>
        `);
    }

    // Hiển thị thông tin suất chiếu
    if (selectedShowtime) {
        $('#showtimeDetails').html(`
            <p><strong>Ngày:</strong> ${selectedShowtime.date || 'Chưa xác định'}</p>
            <p><strong>Giờ:</strong> ${selectedShowtime.time}</p>
        `);
    }

    // Hiển thị ghế đã chọn
    if (selectedSeats && selectedSeats.length > 0) {
        const seatsHtml = selectedSeats.map(seat => 
            `<span class="badge bg-primary me-2">${seat.seatCode} (${seat.seatType || 'Thường'})</span>`
        ).join('');
        $('#selectedSeatsDetails').html(seatsHtml);

        // Tính toán tổng tiền
        const totalSeats = selectedSeats.length;
        const totalAmount = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        const discount = 0; // Có thể thêm logic khuyến mãi sau
        const finalAmount = totalAmount - discount;

        $('#totalSeats').text(totalSeats);
        $('#totalAmount').text(formatCurrency(totalAmount));
        $('#discount').text(formatCurrency(discount));
        $('#finalAmount').text(formatCurrency(finalAmount));
    }

    // Xác nhận đặt vé
    $('#confirmBooking').on('click', function() {
        const paymentMethod = $('input[name="paymentMethod"]:checked').val();

        const bookingData = {
            movieId: selectedMovie.id,
            showtimeId: selectedShowtime.id,
            seats: selectedSeats.map(seat => seat.id),
            paymentMethod: paymentMethod,
            totalAmount: selectedSeats.reduce((sum, seat) => sum + seat.price, 0)
        };

        $.ajax({
            url: '/api/v1/booking-ticket/confirm',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(bookingData),
            success: function(response) {
                if (response.success) {
                    // Hiển thị thông báo thành công
                    Swal.fire({
                        icon: 'success',
                        title: 'Đặt vé thành công!',
                        text: 'Mã đặt vé của bạn: ' + response.data.bookingCode,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Chuyển hướng hoặc làm mới trang
                        window.location.href = '/Dashboard/BookingHistory';
                    });

                    // Xóa dữ liệu localStorage
                    localStorage.removeItem('selectedMovie');
                    localStorage.removeItem('selectedShowtime');
                    localStorage.removeItem('selectedSeats');
                } else {
                    // Hiển thị lỗi
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: response.message || 'Không thể đặt vé. Vui lòng thử lại.'
                    });
                }
            },
            error: function(xhr) {
                console.error('Lỗi khi đặt vé:', xhr);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối',
                    text: 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối internet.'
                });
            }
        });
    });

    // Định dạng tiền tệ
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
});
</script>

<style>
.order-summary {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.95rem;
}

.summary-item.total {
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
    font-size: 1.1rem;
}

.payment-methods {
    display: flex;
    gap: 20px;
}

.payment-methods .form-check {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.payment-methods .form-check:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
}

.payment-methods .form-check input:checked + label {
    color: #007bff;
}
</style>